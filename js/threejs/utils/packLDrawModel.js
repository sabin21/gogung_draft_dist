var ldrawPath="./",materialsFileName="LDConfig.ldr",fs=require("fs"),path=require("path");3!==process.argv.length&&(console.log("Usage: node packLDrawModel <modelFilePath>"),exit(0));var fileName=process.argv[2],materialsFilePath=path.join(ldrawPath,materialsFileName);console.log('Loading materials file "'+materialsFilePath+'"...');var materialsContent=fs.readFileSync(materialsFilePath,{encoding:"utf8"});console.log('Packing "'+fileName+'"...');var objectsPaths=[],objectsContents=[],pathMap={},listOfNotFound=[];parseObject(fileName,!0);for(var someNotFound=!1,i=0;i<listOfNotFound.length;i++)pathMap[listOfNotFound[i]]||(someNotFound=!0,console.log('Error: File object not found: "'+fileName+'".'));someNotFound&&(console.log("Some files were not found, aborting."),process.exit(-1));var packedContent=materialsContent+"\n";for(i=objectsPaths.length-1;i>=0;i--)packedContent+=objectsContents[i];packedContent+="\n";var outPath=fileName+"_Packed.mpd";function parseObject(t,e){console.log('Adding "'+t+'".');for(var a=t,o="",r=null,n=0;n<2;n++){o="",1===n&&(t=t.toLowerCase()),t.startsWith("48/")?o="p/":t.startsWith("s/")&&(o="parts/");var i=path.join(ldrawPath,t);try{r=fs.readFileSync(i,{encoding:"utf8"});break}catch(e){o="parts/",i=path.join(ldrawPath,o,t);try{r=fs.readFileSync(i,{encoding:"utf8"});break}catch(e){o="p/",i=path.join(ldrawPath,o,t);try{r=fs.readFileSync(i,{encoding:"utf8"});break}catch(e){try{o="models/",i=path.join(ldrawPath,o,t),r=fs.readFileSync(i,{encoding:"utf8"});break}catch(t){1===n&&listOfNotFound.push(a)}}}}}var s=path.join(o,t);if(!r)return null;-1!==r.indexOf("\r\n")&&(r=r.replace(/\r\n/g,"\n"));for(var l=e?"":"0 FILE "+s+"\n",c=r.split("\n"),h=0,p=c.length;h<p;h++){for(var f=c[h],d=f.length,g=0;(" "===f.charAt(g)||"\t"===f.charAt(g))&&g<d;)g++;if(d=(f=f.substring(g)).length,g=0,f.startsWith("0 FILE ")){if(0===h)continue;(m=f.substring(g).trim().replace("\\","/"))&&((F=pathMap[m])||(pathMap[m]=m))}if(f.startsWith("1 ")){g=2;for(var u=0;u<13&&g<d;u++){for(;" "!==f.charAt(g)&&"\t"!==f.charAt(g)&&g<d;)g++;for(;(" "===f.charAt(g)||"\t"===f.charAt(g))&&g<d;)g++}var m,F;(m=f.substring(g).trim().replace("\\","/"))&&((F=pathMap[m])||(F=parseObject(m)),pathMap[m]=F||m,l+=f.substring(0,g)+pathMap[m]+"\n")}else l+=f+"\n"}return objectsPaths.indexOf(s)<0&&(objectsPaths.push(s),objectsContents.push(l)),s}console.log('Writing "'+outPath+'"...'),fs.writeFileSync(outPath,packedContent),console.log("Done.");