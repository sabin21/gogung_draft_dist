import{Bone,BufferAttribute,BufferGeometry,FileLoader,ImageLoader,Loader,Matrix4,Mesh,MeshPhongMaterial,Object3D,Texture}from"../../../build/three.module.js";var AWDLoader=function(){var t=!0;function e(){this.id=0,this.data=null,this.namespace=0,this.flags=0}function r(){}r.prototype={set:function(t,e){this[t]=e},get:function(t,e){return this.hasOwnProperty(t)?this[t]:e}};var s=function(t){Loader.call(this,t),this.trunk=new Object3D,this.materialFactory=void 0,this._url="",this._baseDir="",this._data=void 0,this._ptr=0,this._version=[],this._streaming=!1,this._optimized_for_accuracy=!1,this._compression=0,this._bodylen=4294967295,this._blocks=[new e],this._accuracyMatrix=!1,this._accuracyGeo=!1,this._accuracyProps=!1};return s.prototype=Object.assign(Object.create(Loader.prototype),{constructor:s,load:function(t,e,r,s){var a=this;this._url=t,this._baseDir=t.substr(0,t.lastIndexOf("/")+1);var i=new FileLoader(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.load(t,(function(t){e(a.parse(t))}),r,s)},parse:function(t){var e=t.byteLength;for(this._ptr=0,this._data=new DataView(t),this._parseHeader(),0!=this._compression&&console.error("compressed AWD not supported"),this._streaming||this._bodylen==t.byteLength-this._ptr||console.error("AWDLoader: body len does not match file length",this._bodylen,e-this._ptr);this._ptr<e;)this.parseNextBlock();return this.trunk},parseNextBlock:function(){var t,r,s=this.readU32(),a=this.readU8(),i=this.readU8(),h=this.readU8(),n=this.readU32();switch(i){case 1:t=this.parseMeshData();break;case 22:t=this.parseContainer();break;case 23:t=this.parseMeshInstance();break;case 81:t=this.parseMaterial();break;case 82:t=this.parseTexture();break;case 101:t=this.parseSkeleton();break;case 112:t=this.parseMeshPoseAnimation(!1);break;case 113:t=this.parseVertexAnimationSet();break;case 102:t=this.parseSkeletonPose();break;case 103:t=this.parseSkeletonAnimation();break;case 122:t=this.parseAnimatorSet();break;default:this._ptr+=n}this._blocks[s]=r=new e,r.data=t,r.id=s,r.namespace=a,r.flags=h},_parseHeader:function(){var t=this._version;if(4282180!=(this.readU8()<<16|this.readU8()<<8|this.readU8()))throw new Error("AWDLoader - bad magic");t[0]=this.readU8(),t[1]=this.readU8();var e=this.readU16();this._streaming=1==(1&e),2===t[0]&&1===t[1]&&(this._accuracyMatrix=2==(2&e),this._accuracyGeo=4==(4&e),this._accuracyProps=8==(8&e)),this._geoNrType=this._accuracyGeo?8:7,this._matrixNrType=this._accuracyMatrix?8:7,this._propsNrType=this._accuracyProps?8:7,this._optimized_for_accuracy=2==(2&e),this._compression=this.readU8(),this._bodylen=this.readU32()},parseContainer:function(){var t=new Object3D,e=this.readU32(),r=this.parseMatrix4();return t.name=this.readUTF(),t.applyMatrix(r),(this._blocks[e].data||this.trunk).add(t),this.parseProperties({1:this._matrixNrType,2:this._matrixNrType,3:this._matrixNrType,4:4}),t.extra=this.parseUserAttributes(),t},parseMeshInstance:function(){var t,e,r,s,a,i,h,n,o,d,p,u,c;for(i=this.readU32(),n=this.parseMatrix4(),t=this.readUTF(),h=this.readU32(),u=this.readU16(),r=this.getBlock(h),o=[],c=0;c<u;c++)p=this.readU32(),d=this.getBlock(p),o.push(d);if(a=[],(s=r.length)>1)for(e=new Object3D,c=0;c<s;c++){var l=new Mesh(r[c]);a.push(l),e.add(l)}else e=new Mesh(r[0]),a.push(e);e.applyMatrix(n),e.name=t,(this.getBlock(i)||this.trunk).add(e);var f=o.length,_=Math.max(s,f);for(c=0;c<_;c++)a[c%s].material=o[c%f];return this.parseProperties(null),e.extra=this.parseUserAttributes(),e},parseMaterial:function(){var t,e,r,s,a,i;for(t=this.readUTF(),e=this.readU8(),i=this.readU8(),r=this.parseProperties({1:3,2:23,11:21,12:7,13:21});0<i;)this.readU16(),this.parseProperties(null),this.parseUserAttributes();if(a=this.parseUserAttributes(),void 0!==this.materialFactory&&(s=this.materialFactory(t)))return s;if(s=new MeshPhongMaterial,1===e)s.color.setHex(r.get(1,13421772));else if(2===e){var h=r.get(2,0);s.map=this.getBlock(h)}return s.extra=a,s.alphaThreshold=r.get(12,0),s.repeat=r.get(13,!1),s},parseTexture:function(){var t,e,r=this.readUTF();if(0===this.readU8()){e=this.readU32();var s=this.readUTFBytes(e);console.log(s),(t=this.loadTexture(s)).userData={},t.userData.name=r}return this.parseProperties(null),this.parseUserAttributes(),t},loadTexture:function(t){var e=new Texture;return new ImageLoader(this.manager).load(this._baseDir+t,(function(t){e.image=t,e.needsUpdate=!0})),e},parseSkeleton:function(){this.readUTF();var t=this.readU16(),e=[],r=0;for(this.parseProperties(null);r<t;){var s,a;this.readU16(),(s=new Bone).parent=this.readU16()-1,s.name=this.readUTF(),a=this.parseMatrix4(),s.skinMatrix=a,this.parseProperties(null),this.parseUserAttributes(),e.push(s),r++}return this.parseUserAttributes(),e},parseSkeletonPose:function(){this.readUTF();var t=this.readU16();this.parseProperties(null);for(var e=[],r=0;r<t;){var s;s=1===this.readU8()?this.parseMatrix4():new Matrix4,e[r]=s,r++}return this.parseUserAttributes(),e},parseSkeletonAnimation:function(){this.readUTF();var t,e,r,s=[],a=this.readU16();this.parseProperties(null);for(var i=0;i<a;)e=this.readU32(),t=this.readU16(),r=this._blocks[e].data,s.push({pose:r,duration:t}),i++;if(0!==s.length)return this.parseUserAttributes(),s},parseVertexAnimationSet:function(){this.readUTF();for(var t,e=this.readU16(),r=(this.parseProperties({1:5}),0),s=[];r<e;)t=this.readU32(),s.push(this._blocks[t].data),r++;return this.parseUserAttributes(),s},parseAnimatorSet:function(){this.readUTF();var t,e,r=this.readU16(),s=this.parseProperties({1:23});t=this.readU32();for(var a=this.readU16(),i=[],h=0;h<a;h++)i.push(this.readU32());this.readU16(),Boolean(this.readU8()),this.parseUserAttributes(),this.parseUserAttributes();var n,o=[];for(h=0;h<i.length;h++)o.push(this._blocks[i[h]].data);for(e=this._blocks[t].data,1==r&&(n={animationSet:e,skeleton:this._blocks[s.get(1,0)].data}),h=0;h<o.length;h++)o[h].animator=n;return n},parseMeshData:function(){var t,e,r=this.readUTF(),s=this.readU16(),a=0,i=[];for(this.parseProperties({1:this._geoNrType,2:this._geoNrType});a<s;){var h,n,o;for((t=new BufferGeometry).name=r,i.push(t),h=this.readU32(),n=this._ptr+h,this.parseProperties({1:this._geoNrType,2:this._geoNrType});this._ptr<n;){var d=0,p=this.readU8(),u=(this.readU8(),this.readU32()),c=u+this._ptr;if(1===p)for(e=new Float32Array(u/12*3),o=new BufferAttribute(e,3),t.addAttribute("position",o),d=0;this._ptr<c;)e[d]=-this.readF32(),e[d+1]=this.readF32(),e[d+2]=this.readF32(),d+=3;else if(2===p)for(e=new Uint16Array(u/2),o=new BufferAttribute(e,1),t.setIndex(o),d=0;this._ptr<c;)e[d+1]=this.readU16(),e[d]=this.readU16(),e[d+2]=this.readU16(),d+=3;else if(3===p)for(e=new Float32Array(u/8*2),o=new BufferAttribute(e,2),t.addAttribute("uv",o),d=0;this._ptr<c;)e[d]=this.readF32(),e[d+1]=1-this.readF32(),d+=2;else if(4===p)for(e=new Float32Array(u/12*3),o=new BufferAttribute(e,3),t.addAttribute("normal",o),d=0;this._ptr<c;)e[d]=-this.readF32(),e[d+1]=this.readF32(),e[d+2]=this.readF32(),d+=3;else this._ptr=c}this.parseUserAttributes(),t.computeBoundingSphere(),a++}return this.parseUserAttributes(),i},parseMeshPoseAnimation:function(t){var e,r,s,a,i,h,n,o,d,p=1,u=0,c={},l=[],f=(this.readUTF(),this.readU32()),_=this.getBlock(f);if(null!==_){for((h=_.geometry).morphTargets=[],t||(p=this.readU16()),e=this.readU16(),n=this.readU16(),o=0;o<n;)l.push(this.readU16()),o++;for(d=this.parseProperties({1:21,2:21}),c.looping=d.get(1,!0),c.stitchFinalFrame=d.get(2,!1),r=0;r<p;){for(this.readU16(),s=0;s<e;)for(o=0,a=this.readU32(),i=this._ptr+a;o<n;){if(1===l[o]){var U=new Float32Array(a/4);for(h.morphTargets.push({array:U}),u=0;this._ptr<i;)U[u]=this.readF32(),U[u+1]=this.readF32(),U[u+2]=this.readF32(),u+=3;s++}else this._ptr=i;o++}r++}return this.parseUserAttributes(),null}console.log("parseMeshPoseAnimation target mesh not found at:",f)},getBlock:function(t){return this._blocks[t].data},parseMatrix4:function(){var t=new Matrix4,e=t.elements;return e[0]=this.readF32(),e[1]=this.readF32(),e[2]=this.readF32(),e[3]=0,e[4]=this.readF32(),e[5]=this.readF32(),e[6]=this.readF32(),e[7]=0,e[8]=this.readF32(),e[9]=this.readF32(),e[10]=this.readF32(),e[11]=0,e[12]=-this.readF32(),e[13]=this.readF32(),e[14]=this.readF32(),e[15]=1,t},parseProperties:function(t){var e=this.readU32(),s=this._ptr+e,a=new r;if(t)for(;this._ptr<s;){var i,h=this.readU16(),n=this.readU32();t.hasOwnProperty(h)?(i=t[h],a.set(h,this.parseAttrValue(i,n))):this._ptr+=n}return a},parseUserAttributes:function(){return this._ptr=this.readU32()+this._ptr,null},parseAttrValue:function(t,e){var r,s;switch(t){case 1:r=1,s=this.readI8;break;case 2:r=2,s=this.readI16;break;case 3:r=4,s=this.readI32;break;case 21:case 4:r=1,s=this.readU8;break;case 5:r=2,s=this.readU16;break;case 6:case 23:r=4,s=this.readU32;break;case 7:r=4,s=this.readF32;break;case 8:case 41:case 42:case 43:case 44:case 45:case 46:case 47:r=8,s=this.readF64}if(r<e){var a,i,h;for(a=[],i=0,h=e/r;i<h;)a.push(s.call(this)),i++;return a}return s.call(this)},readU8:function(){return this._data.getUint8(this._ptr++)},readI8:function(){return this._data.getInt8(this._ptr++)},readU16:function(){var e=this._data.getUint16(this._ptr,t);return this._ptr+=2,e},readI16:function(){var e=this._data.getInt16(this._ptr,t);return this._ptr+=2,e},readU32:function(){var e=this._data.getUint32(this._ptr,t);return this._ptr+=4,e},readI32:function(){var e=this._data.getInt32(this._ptr,t);return this._ptr+=4,e},readF32:function(){var e=this._data.getFloat32(this._ptr,t);return this._ptr+=4,e},readF64:function(){var e=this._data.getFloat64(this._ptr,t);return this._ptr+=8,e},readUTF:function(){var t=this.readU16();return this.readUTFBytes(t)},readUTFBytes:function(e){for(var r=[],s=0;r.length<e;){var a=this._data.getUint8(this._ptr++,t);if(a<128)r[s++]=String.fromCharCode(a);else if(a>191&&a<224){var i=this._data.getUint8(this._ptr++,t);r[s++]=String.fromCharCode((31&a)<<6|63&i)}else{i=this._data.getUint8(this._ptr++,t);var h=this._data.getUint8(this._ptr++,t);r[s++]=String.fromCharCode((15&a)<<12|(63&i)<<6|63&h)}}return r.join("")}}),s}();export{AWDLoader};