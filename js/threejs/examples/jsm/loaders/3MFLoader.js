import{BufferAttribute,BufferGeometry,FileLoader,Group,Loader,LoaderUtils,Matrix4,Mesh,MeshPhongMaterial}from"../../../build/three.module.js";var ThreeMFLoader=function(e){Loader.call(this,e),this.availableExtensions=[]};ThreeMFLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:ThreeMFLoader,load:function(e,t,r,a){var n=this,o=new FileLoader(n.manager);o.setPath(n.path),o.setResponseType("arraybuffer"),o.load(e,(function(e){t(n.parse(e))}),r,a)},parse:function(e){var t=this;function r(e){var t={};return t.name=e.getAttribute("name"),t.displaycolor=e.getAttribute("displaycolor"),t}function a(e){var t={};t.objectId=e.getAttribute("objectid");var r=e.getAttribute("transform");return r&&(t.transform=n(r)),t}function n(e){var t=[];e.split(" ").forEach((function(e){t.push(parseFloat(e))}));var r=new Matrix4;return r.set(t[0],t[3],t[6],t[9],t[1],t[4],t[7],t[10],t[2],t[5],t[8],t[11],0,0,0,1),r}function o(e){var t={type:e.getAttribute("type")},r=e.getAttribute("id");r&&(t.id=r);var n=e.getAttribute("pid");n&&(t.pid=n);var o=e.getAttribute("pindex");o&&(t.pindex=o);var i=e.getAttribute("thumbnail");i&&(t.thumbnail=i);var s=e.getAttribute("partnumber");s&&(t.partnumber=s);var l=e.getAttribute("name");l&&(t.name=l);var u=e.querySelector("mesh");u&&(t.mesh=function(e){for(var t={},r=[],a=e.querySelectorAll("vertices vertex"),n=0;n<a.length;n++){var o=a[n],i=o.getAttribute("x"),s=o.getAttribute("y"),l=o.getAttribute("z");r.push(parseFloat(i),parseFloat(s),parseFloat(l))}for(t.vertices=new Float32Array(r.length),n=0;n<r.length;n++)t.vertices[n]=r[n];var u=[],c=[],p=e.querySelectorAll("triangles triangle");for(n=0;n<p.length;n++){var d=p[n],g=d.getAttribute("v1"),f=d.getAttribute("v2"),h=d.getAttribute("v3"),v=d.getAttribute("p1"),b=d.getAttribute("p2"),m=d.getAttribute("p3"),y=d.getAttribute("pid");c.push(parseInt(g,10),parseInt(f,10),parseInt(h,10));var A={};v&&(A.p1=parseInt(v,10)),b&&(A.p2=parseInt(b,10)),m&&(A.p3=parseInt(m,10)),y&&(A.pid=y),0<Object.keys(A).length&&u.push(A)}for(t.triangleProperties=u,t.triangles=new Uint32Array(c.length),n=0;n<c.length;n++)t.triangles[n]=c[n];return t}(u));var c=e.querySelector("components");return c&&(t.components=function(e){for(var t=[],r=e.querySelectorAll("component"),n=0;n<r.length;n++){var o=a(r[n]);t.push(o)}return t}(c)),t}function i(e){var t={unit:e.getAttribute("unit")||"millimeter"},a=e.querySelectorAll("metadata");a&&(t.metadata=function(e){for(var t={},r=0;r<e.length;r++){var a=e[r],n=a.getAttribute("name");0<=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"].indexOf(n)&&(t[n]=a.textContent)}return t}(a));var i=e.querySelector("resources");i&&(t.resources=function(e){var t={},a=e.querySelector("basematerials");a&&(t.basematerials=function(e){for(var t={id:e.getAttribute("id"),basematerials:[]},a=e.querySelectorAll("base"),n=0;n<a.length;n++){var o=r(a[n]);t.basematerials.push(o)}return t}(a)),t.object={};for(var n=e.querySelectorAll("object"),i=0;i<n.length;i++){var s=o(n[i]);t.object[s.id]=s}return t}(i));var s=e.querySelector("build");return s&&(t.build=function(e){for(var t=[],r=e.querySelectorAll("item"),a=0;a<r.length;a++){var o=r[a],i={objectId:o.getAttribute("objectid")},s=o.getAttribute("transform");s&&(i.transform=n(s)),t.push(i)}return t}(s)),t}function s(e,t,r,a){var n=new BufferGeometry;n.setIndex(new BufferAttribute(e.triangles,1)),n.addAttribute("position",new BufferAttribute(e.vertices,3));for(var o,i=r.resources.basematerials,s=e.triangleProperties,c=0,p=0,d=-1,g=0,f=s.length;g<f;g++){var h=s[g],v=h.pid;i&&i.id===v&&(-1===d&&(d=h.p1),d===h.p1?p+=3:(n.addGroup(c,p,d),c+=p,p=3,d=h.p1))}if(n.groups.length>0&&function(e){for(var t=e.groups.sort((function(e,t){return e.materialIndex!==t.materialIndex?e.materialIndex-t.materialIndex:e.start-t.start})),r=e.index,a=r.itemSize,n=r.array,o=0,i=new n.constructor(n.length),s=0;s<t.length;s++){var l=t[s],u=l.count*a,c=l.start*a,p=n.subarray(c,c+u);i.set(p,o),o+=u}n.set(i);var d=0;for(s=0;s<t.length;s++)(l=t[s]).start=d,d+=l.count;var g=t[0];for(e.groups=[g],s=1;s<t.length;s++)l=t[s],g.materialIndex===l.materialIndex?g.count+=l.count:(g=l,e.groups.push(g))}(n),n.computeBoundingSphere(),i&&i.id===a.pid){var b=a.pindex;o=l(A=i.basematerials[b],t,r,a,u)}if(n.groups.length>0){var m=n.groups;for(o=[],g=0,f=m.length;g<f;g++){var y=m[g],A=i.basematerials[y.materialIndex];o.push(l(A,t,r,a,u))}}return void 0===o&&(o=new MeshPhongMaterial({color:11184895,flatShading:!0})),new Mesh(n,o)}function l(e,t,r,a,n){return void 0!==e.build||(e.build=n(e,t,r,a)),e.build}function u(e){var t=new MeshPhongMaterial({flatShading:!0});t.name=e.name;var r=e.displaycolor,a=r.substring(0,7);return t.color.setStyle(a),t.color.convertSRGBToLinear(),9===r.length&&(t.opacity=parseInt(r.charAt(7)+r.charAt(8),16)/255),t}function c(e,t,r){for(var a=new Group,n=0;n<e.length;n++){var o=e[n],i=t[o.objectId];void 0===i&&(p(o.objectId,t,r),i=t[o.objectId]);var s=i.clone(),l=o.transform;l&&s.applyMatrix(l),a.add(s)}return a}function p(e,r,a){var n=a.resources.object[e];if(n.mesh){var o=n.mesh;!function(e,r,a){if(e){for(var n=[],o=Object.keys(e),i=0;i<o.length;i++)for(var s=o[i],l=0;l<t.availableExtensions.length;l++)(u=t.availableExtensions[l]).ns===s&&n.push(u);for(i=0;i<n.length;i++){var u;(u=n[i]).apply(a,e[u.ns],r)}}}(a.extensions,o,a.xml),r[n.id]=l(o,r,a,n,s)}else{var i=n.components;r[n.id]=l(i,r,a,n,c)}}var d=function(e){var t,r,a=null,n=null,o=[],s=[],l=[],u=[],c={},p={};try{a=new JSZip(e)}catch(e){if(e instanceof ReferenceError)return console.error("THREE.3MFLoader: jszip missing and file is compressed."),null}for(n in a.files)n.match(/\_rels\/.rels$/)?t=n:n.match(/^3D\/.*\.model$/)?o.push(n):n.match(/^3D\/Metadata\/.*\.xml$/)?s.push(n):n.match(/^3D\/Textures\/.*/)?l.push(n):n.match(/^3D\/Other\/.*/)&&u.push(n);var d,g,f=new Uint8Array(a.file(t).asArrayBuffer());d=LoaderUtils.decodeText(f),r={target:(g=(new DOMParser).parseFromString(d,"application/xml").querySelector("Relationship")).getAttribute("Target"),id:g.getAttribute("Id"),type:g.getAttribute("Type")};for(var h=0;h<o.length;h++){var v=o[h],b=new Uint8Array(a.file(v).asArrayBuffer()),m=LoaderUtils.decodeText(b),y=(new DOMParser).parseFromString(m,"application/xml");"model"!==y.documentElement.nodeName.toLowerCase()&&console.error("THREE.3MFLoader: Error loading 3MF - no 3MF document found: ",v);var A=y.querySelector("model"),x={};for(h=0;h<A.attributes.length;h++){var M=A.attributes[h];M.name.match(/^xmlns:(.+)$/)&&(x[M.value]=RegExp.$1)}var S=i(A);S.xml=A,0<Object.keys(x).length&&(S.extensions=x),c[v]=S}for(h=0;h<l.length;h++){var j=l[h];p[j]=a.file(j).asBinary()}return{rels:r,model:c,printTicket:{},texture:p,other:{}}}(e),g=function(e){for(var t=e.model,r={},a=Object.keys(t),n=0;n<a.length;n++)for(var o=t[a[n]],i=Object.keys(o.resources.object),s=0;s<i.length;s++)p(i[s],r,o);return r}(d);return function(e,t,r){for(var a=new Group,n=r.model[t.target.substring(1)].build,o=0;o<n.length;o++){var i=n[o],s=e[i.objectId],l=i.transform;l&&s.applyMatrix(l),a.add(s)}return a}(g,d.rels,d)},addExtension:function(e){this.availableExtensions.push(e)}});export{ThreeMFLoader};