import{FileLoader,Loader,Matrix4,Vector3}from"../../../build/three.module.js";import{Zlib}from"../libs/gunzip.module.min.js";import{Volume}from"../misc/Volume.js";var NRRDLoader=function(r){Loader.call(this,r)};NRRDLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:NRRDLoader,load:function(r,e,t,n){var a=this,i=new FileLoader(a.manager);i.setPath(a.path),i.setResponseType("arraybuffer"),i.load(r,(function(r){e(a.parse(r))}),t,n)},parse:function(r){var e=r,t=0,n=new Int8Array(new Int16Array([1]).buffer)[0]>0,a={},i=function(r,a){null==a&&(a=1);var i=1,s=Uint8Array;var o=new s(e.slice(t,t+=a*i));return 1!=n&&(o=function(r,e){for(var t=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),n=0;n<r.byteLength;n+=e)for(var a=n+e-1,i=n;a>i;a--,i++){var s=t[i];t[i]=t[a],t[a]=s}return r}(o,i)),1==a?o[0]:o}(0,r.byteLength),s=i.length,o=null,c=0;for(p=1;p<s;p++)if(10==i[p-1]&&10==i[p]){o=this.parseChars(i,0,p-2),c=p+1;break}if(function(r){var e,t,n,i,s,o,c,u,h;for(u=0,h=(o=r.split(/\r?\n/)).length;u<h;u++)(s=o[u]).match(/NRRD\d+/)?a.isNrrd=!0:s.match(/^#/)||(c=s.match(/(.*):(.*)/))&&(t=c[1].trim(),e=c[2].trim(),(n=NRRDLoader.prototype.fieldFunctions[t])?n.call(a,e):a[t]=e);if(!a.isNrrd)throw new Error("Not an NRRD file");if("bz2"===a.encoding||"bzip2"===a.encoding)throw new Error("Bzip is not supported");if(!a.vectors&&(a.vectors=[new Vector3(1,0,0),new Vector3(0,1,0),new Vector3(0,0,1)],a.spacings))for(i=0;i<=2;i++)isNaN(a.spacings[i])||a.vectors[i].multiplyScalar(a.spacings[i])}(o),e=i.subarray(c),"gzip"===a.encoding||"gz"===a.encoding){var u=new Zlib.Gunzip(new Uint8Array(e));e=u.decompress()}else if("ascii"===a.encoding||"text"===a.encoding||"txt"===a.encoding||"hex"===a.encoding)e=function(r,e,t){var n,i="";e=e||0,t=t||r.length;var s=a.sizes.reduce((function(r,e){return r*e}),1),o=10;"hex"===a.encoding&&(o=16);var c=new a.__array(s),u=0,h=parseInt;a.__array!==Float32Array&&a.__array!==Float64Array||(h=parseFloat);for(var p=e;p<t;p++)((n=r[p])<9||n>13)&&32!==n?i+=String.fromCharCode(n):(""!==i&&(c[u]=h(i,o),u++),i="");return""!==i&&(c[u]=h(i,o),u++),c}(e);else if("raw"===a.encoding){for(var h=new Uint8Array(e.length),p=0;p<e.length;p++)h[p]=e[p];e=h}e=e.buffer;var l=new Volume;l.header=a,l.data=new a.__array(e);var d=l.computeMinMax(),f=d[0],g=d[1];l.windowLow=f,l.windowHigh=g,l.dimensions=[a.sizes[0],a.sizes[1],a.sizes[2]],l.xLength=l.dimensions[0],l.yLength=l.dimensions[1],l.zLength=l.dimensions[2];var v=new Vector3(a.vectors[0][0],a.vectors[0][1],a.vectors[0][2]).length(),y=new Vector3(a.vectors[1][0],a.vectors[1][1],a.vectors[1][2]).length(),m=new Vector3(a.vectors[2][0],a.vectors[2][1],a.vectors[2][2]).length();l.spacing=[v,y,m],l.matrix=new Matrix4;var w=1,_=1;if("left-posterior-superior"==a.space?(w=-1,_=-1):"left-anterior-superior"===a.space&&(w=-1),a.vectors){var b=a.vectors;l.matrix.set(w*b[0][0],w*b[1][0],w*b[2][0],0,_*b[0][1],_*b[1][1],_*b[2][1],0,1*b[0][2],1*b[1][2],1*b[2][2],0,0,0,0,1)}else l.matrix.set(w,0,0,0,0,_,0,0,0,0,1,0,0,0,0,1);return l.inverseMatrix=new Matrix4,l.inverseMatrix.getInverse(l.matrix),l.RASDimensions=new Vector3(l.xLength,l.yLength,l.zLength).applyMatrix4(l.matrix).round().toArray().map(Math.abs),l.lowerThreshold===-1/0&&(l.lowerThreshold=f),l.upperThreshold===1/0&&(l.upperThreshold=g),l},parseChars:function(r,e,t){void 0===e&&(e=0),void 0===t&&(t=r.length);var n="",a=0;for(a=e;a<t;++a)n+=String.fromCharCode(r[a]);return n},fieldFunctions:{type:function(r){switch(r){case"uchar":case"unsigned char":case"uint8":case"uint8_t":this.__array=Uint8Array;break;case"signed char":case"int8":case"int8_t":this.__array=Int8Array;break;case"short":case"short int":case"signed short":case"signed short int":case"int16":case"int16_t":this.__array=Int16Array;break;case"ushort":case"unsigned short":case"unsigned short int":case"uint16":case"uint16_t":this.__array=Uint16Array;break;case"int":case"signed int":case"int32":case"int32_t":this.__array=Int32Array;break;case"uint":case"unsigned int":case"uint32":case"uint32_t":this.__array=Uint32Array;break;case"float":this.__array=Float32Array;break;case"double":this.__array=Float64Array;break;default:throw new Error("Unsupported NRRD data type: "+r)}return this.type=r},endian:function(r){return this.endian=r},encoding:function(r){return this.encoding=r},dimension:function(r){return this.dim=parseInt(r,10)},sizes:function(r){var e;return this.sizes=function(){var t,n,a,i;for(i=[],t=0,n=(a=r.split(/\s+/)).length;t<n;t++)e=a[t],i.push(parseInt(e,10));return i}()},space:function(r){return this.space=r},"space origin":function(r){return this.space_origin=r.split("(")[1].split(")")[0].split(",")},"space directions":function(r){var e,t,n;return t=r.match(/\(.*?\)/g),this.vectors=function(){var r,a,i;for(i=[],r=0,a=t.length;r<a;r++)n=t[r],i.push(function(){var r,t,a,i;for(i=[],r=0,t=(a=n.slice(1,-1).split(/,/)).length;r<t;r++)e=a[r],i.push(parseFloat(e));return i}());return i}()},spacings:function(r){var e,t;return t=r.split(/\s+/),this.spacings=function(){var r,n,a=[];for(r=0,n=t.length;r<n;r++)e=t[r],a.push(parseFloat(e));return a}()}}});export{NRRDLoader};