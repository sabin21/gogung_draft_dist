import{BufferAttribute,BufferGeometry,FileLoader,Float32BufferAttribute,Loader,LoaderUtils}from"../../../build/three.module.js";import{Zlib}from"../libs/inflate.module.min.js";var VTKLoader=function(t){Loader.call(this,t)};VTKLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:VTKLoader,load:function(t,e,r,a){var n=this,o=new FileLoader(n.manager);o.setPath(n.path),o.setResponseType("arraybuffer"),o.load(t,(function(t){e(n.parse(t))}),r,a)},parse:function(t){function e(t,e){var r=t.length,a=new Int32Array(r+e.length);return a.set(t),a.set(e,r),a}function r(t){for(var e="",r=new Uint8Array(t),a=0,n=r.length;n--;)e+=String.fromCharCode(r[a++]);return e}var a=LoaderUtils.decodeText(new Uint8Array(t,0,250)).split("\n");return-1!==a[0].indexOf("xml")?function(t){function r(t){var e,r,a,n,o,i,s="undefined"!=typeof Uint8Array?Uint8Array:Array,l=[],f=[],u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",p=u.length;for(e=0;e<p;e++)l[e]=u[e];for(e=0;e<p;++e)f[u.charCodeAt(e)]=e;if(f["-".charCodeAt(0)]=62,f["_".charCodeAt(0)]=63,(p=t.length)%4>0)throw new Error("Invalid string. Length must be a multiple of 4");i=new s(3*p/4-(o="="===t[p-2]?2:"="===t[p-1]?1:0)),a=o>0?p-4:p;var d=0;for(e=0,r=0;e<a;e+=4,r+=3)n=f[t.charCodeAt(e)]<<18|f[t.charCodeAt(e+1)]<<12|f[t.charCodeAt(e+2)]<<6|f[t.charCodeAt(e+3)],i[d++]=(16711680&n)>>16,i[d++]=(65280&n)>>8,i[d++]=255&n;return 2===o?(n=f[t.charCodeAt(e)]<<2|f[t.charCodeAt(e+1)]>>4,i[d++]=255&n):1===o&&(n=f[t.charCodeAt(e)]<<10|f[t.charCodeAt(e+1)]<<4|f[t.charCodeAt(e+2)]>>2,i[d++]=n>>8&255,i[d++]=255&n),i}function a(t,a){var n,i,s,l,f=0;if("UInt64"===o.attributes.header_type?f=8:"UInt32"===o.attributes.header_type&&(f=4),"binary"===t.attributes.format&&a){var u,p,d,A,h,y;if("Float32"===t.attributes.type)var b=new Float32Array;else"Int64"===t.attributes.type&&(b=new Int32Array);p=(u=r(t["#text"]))[0];for(var c=1;c<f-1;c++)p|=u[c]<<c*f;for(A=(p+3)*f,y=A+=A%3>0?3-A%3:0,(h=[]).push(y),d=3*f,c=0;c<p;c++){for(var v=u[c*f+d],w=1;w<f-1;w++)v|=u[c*f+d+w]<<8*w;y+=v,h.push(y)}for(c=0;c<h.length-1;c++)x=(x=new Zlib.Inflate(u.slice(h[c],h[c+1]),{resize:!0,verify:!0}).decompress()).buffer,"Float32"===t.attributes.type?(i=x=new Float32Array(x),void 0,l=void 0,s=(n=b).length,(l=new Float32Array(s+i.length)).set(n),l.set(i,s),b=l):"Int64"===t.attributes.type&&(b=e(b,x=new Int32Array(x)));delete t["#text"],"Int64"===t.attributes.type&&"binary"===t.attributes.format&&(b=b.filter((function(t,e){if(e%2!=1)return!0})))}else{if("binary"!==t.attributes.format||a)if(t["#text"])var x=t["#text"].split(/\s+/).filter((function(t){if(""!==t)return t}));else x=new Int32Array(0).buffer;else x=(x=r(t["#text"])).slice(f).buffer;delete t["#text"],"Float32"===t.attributes.type?b=new Float32Array(x):"Int32"===t.attributes.type?b=new Int32Array(x):"Int64"===t.attributes.type&&(b=new Int32Array(x),"binary"===t.attributes.format&&(b=b.filter((function(t,e){if(e%2!=1)return!0}))))}return b}var n=null;if(window.DOMParser)try{n=(new DOMParser).parseFromString(t,"text/xml")}catch(t){n=null}else{if(!window.ActiveXObject)throw new Error("Cannot parse xml string!");try{if((n=new ActiveXObject("Microsoft.XMLDOM")).async=!1,!n.loadXML())throw new Error(n.parseError.reason+n.parseError.srcText)}catch(t){n=null}}var o=function t(e){var r={};if(1===e.nodeType){if(e.attributes&&e.attributes.length>0){r.attributes={};for(var a=0;a<e.attributes.length;a++){var n=e.attributes.item(a);r.attributes[n.nodeName]=n.nodeValue.trim()}}}else 3===e.nodeType&&(r=e.nodeValue.trim());if(e.hasChildNodes())for(var o=0;o<e.childNodes.length;o++){var i=e.childNodes.item(o),s=i.nodeName;if(void 0===r[s])""!==(f=t(i))&&(r[s]=f);else{if(void 0===r[s].push){var l=r[s];r[s]=[l]}var f;""!==(f=t(i))&&r[s].push(f)}}return r}(n.documentElement),i=[],s=[],l=[];if(o.PolyData){for(var f=o.PolyData.Piece,u=o.attributes.hasOwnProperty("compressor"),p=["PointData","Points","Strips","Polys"],d=0,A=p.length;d<A;){var h=f[p[d]];if(h&&h.DataArray){if("[object Array]"===Object.prototype.toString.call(h.DataArray))var y=h.DataArray;else y=[h.DataArray];for(var b=0,c=y.length;b<c;)"#text"in y[b]&&y[b]["#text"].length>0&&(y[b].text=a(y[b],u)),b++;switch(p[d]){case"PointData":var v=parseInt(f.attributes.NumberOfPoints),w=h.attributes.Normals;if(v>0)for(var x=0,I=y.length;x<I;x++)if(w===y[x].attributes.Name){var g=y[x].attributes.NumberOfComponents;(s=new Float32Array(v*g)).set(y[x].text,0)}break;case"Points":(v=parseInt(f.attributes.NumberOfPoints))>0&&(g=h.DataArray.attributes.NumberOfComponents,(i=new Float32Array(v*g)).set(h.DataArray.text,0));break;case"Strips":var m=parseInt(f.attributes.NumberOfStrips);if(m>0){var O=new Int32Array(h.DataArray[0].text.length),F=new Int32Array(h.DataArray[1].text.length);O.set(h.DataArray[0].text,0),F.set(h.DataArray[1].text,0);var D=m+O.length;l=new Uint32Array(3*D-9*m);var T=0;for(x=0,I=m;x<I;x++){for(var L=[],P=0,S=F[x],C=0;P<S-C;P++)L.push(O[P]),x>0&&(C=F[x-1]);var N=0;for(S=F[x],C=0;N<S-C-2;N++)N%2?(l[T++]=L[N],l[T++]=L[N+2],l[T++]=L[N+1]):(l[T++]=L[N],l[T++]=L[N+1],l[T++]=L[N+2]),x>0&&(C=F[x-1])}}break;case"Polys":var E=parseInt(f.attributes.NumberOfPolys);if(E>0){O=new Int32Array(h.DataArray[0].text.length),F=new Int32Array(h.DataArray[1].text.length),O.set(h.DataArray[0].text,0),F.set(h.DataArray[1].text,0),D=E+O.length,l=new Uint32Array(3*D-9*E),T=0;var B=0;for(x=0,I=E,C=0;x<I;){var U=[];for(P=0,S=F[x];P<S-C;)U.push(O[B++]),P++;for(N=1;N<S-C-1;)l[T++]=U[0],l[T++]=U[N],l[T++]=U[N+1],N++;C=F[++x-1]}}}}d++}var j=new BufferGeometry;return j.setIndex(new BufferAttribute(l,1)),j.addAttribute("position",new BufferAttribute(i,3)),s.length===i.length&&j.addAttribute("normal",new BufferAttribute(s,3)),j}throw new Error("Unsupported DATASET type")}(r(t)):a[2].includes("ASCII")?function(t){var e,r=[],a=[],n=[],o=[],i=/(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)/g,s=/^(\d+)\s+([\s\d]*)/,l=/^POINTS /,f=/^POLYGONS /,u=/^TRIANGLE_STRIPS /,p=/^POINT_DATA[ ]+(\d+)/,d=/^CELL_DATA[ ]+(\d+)/,A=/^COLOR_SCALARS[ ]+(\w+)[ ]+3/,h=/^NORMALS[ ]+(\w+)[ ]+(\w+)/,y=!1,b=!1,c=!1,v=!1,w=!1,x=!1,I=!1,g=t.split("\n");for(var m in g){var O=g[m];if(0===O.indexOf("DATASET")){var F=O.split(" ")[1];if("POLYDATA"!==F)throw new Error("Unsupported DATASET type: "+F)}else if(y)for(;null!==(e=i.exec(O));){var D=parseFloat(e[1]),T=parseFloat(e[2]),L=parseFloat(e[3]);a.push(D,T,L)}else if(b){if(null!==(e=s.exec(O))){var P=parseInt(e[1]),S=e[2].split(/\s+/);if(P>=3)for(var C=parseInt(S[0]),N=1,E=0;E<P-2;++E)B=parseInt(S[N]),U=parseInt(S[N+1]),r.push(C,B,U),N++}}else if(c){if(null!==(e=s.exec(O))){var B,U;if(P=parseInt(e[1]),S=e[2].split(/\s+/),P>=3)for(E=0;E<P-2;E++)E%2==1?(C=parseInt(S[E]),B=parseInt(S[E+2]),U=parseInt(S[E+1]),r.push(C,B,U)):(C=parseInt(S[E]),B=parseInt(S[E+1]),U=parseInt(S[E+2]),r.push(C,B,U))}}else if(v||w)if(x)for(;null!==(e=i.exec(O));){var j=parseFloat(e[1]),G=parseFloat(e[2]),R=parseFloat(e[3]);n.push(j,G,R)}else if(I)for(;null!==(e=i.exec(O));){var _=parseFloat(e[1]),M=parseFloat(e[2]),V=parseFloat(e[3]);o.push(_,M,V)}null!==f.exec(O)?(b=!0,y=!1,c=!1):null!==l.exec(O)?(b=!1,y=!0,c=!1):null!==u.exec(O)?(b=!1,y=!1,c=!0):null!==p.exec(O)?(v=!0,y=!1,b=!1,c=!1):null!==d.exec(O)?(w=!0,y=!1,b=!1,c=!1):null!==A.exec(O)?(x=!0,I=!1,y=!1,b=!1,c=!1):null!==h.exec(O)&&(I=!0,x=!1,y=!1,b=!1,c=!1)}var k=new BufferGeometry;if(k.setIndex(r),k.addAttribute("position",new Float32BufferAttribute(a,3)),o.length===a.length&&k.addAttribute("normal",new Float32BufferAttribute(o,3)),n.length!==r.length)n.length===a.length&&k.addAttribute("color",new Float32BufferAttribute(n,3));else{var K=(k=k.toNonIndexed()).attributes.position.count/3;if(n.length===3*K){var X=[];for(m=0;m<K;m++)j=n[3*m+0],G=n[3*m+1],R=n[3*m+2],X.push(j,G,R),X.push(j,G,R),X.push(j,G,R);k.addAttribute("color",new Float32BufferAttribute(X,3))}}return k}(r(t)):function(t){var e,r,a,n,o,i,s,l=new Uint8Array(t),f=new DataView(t),u=[],p=[],d=[],A=[],h=0;function y(t,e){for(var r=e,a=t[r],n=[];10!==a;)n.push(String.fromCharCode(a)),a=t[++r];return{start:e,end:r,next:r+1,parsedString:n.join("")}}for(;;){if(0===(s=(i=y(l,h)).parsedString).indexOf("DATASET")){var b=s.split(" ")[1];if("POLYDATA"!==b)throw new Error("Unsupported DATASET type: "+b)}else if(0===s.indexOf("POINTS")){for(A.push(s),e=4*(n=parseInt(s.split(" ")[1],10))*3,u=new Float32Array(3*n),r=i.next,a=0;a<n;a++)u[3*a]=f.getFloat32(r,!1),u[3*a+1]=f.getFloat32(r+4,!1),u[3*a+2]=f.getFloat32(r+8,!1),r+=12;i.next=i.next+e+1}else if(0===s.indexOf("TRIANGLE_STRIPS")){var c=parseInt(s.split(" ")[1],10);e=4*(g=parseInt(s.split(" ")[2],10)),d=new Uint32Array(3*g-9*c);var v=0;for(r=i.next,a=0;a<c;a++){var w=f.getInt32(r,!1),x=[];for(r+=4,o=0;o<w;o++)x.push(f.getInt32(r,!1)),r+=4;for(var I=0;I<w-2;I++)I%2?(d[v++]=x[I],d[v++]=x[I+2],d[v++]=x[I+1]):(d[v++]=x[I],d[v++]=x[I+1],d[v++]=x[I+2])}i.next=i.next+e+1}else if(0===s.indexOf("POLYGONS")){var g;for(c=parseInt(s.split(" ")[1],10),e=4*(g=parseInt(s.split(" ")[2],10)),d=new Uint32Array(3*g-9*c),v=0,r=i.next,a=0;a<c;a++){for(w=f.getInt32(r,!1),x=[],r+=4,o=0;o<w;o++)x.push(f.getInt32(r,!1)),r+=4;for(I=1;I<w-1;I++)d[v++]=x[0],d[v++]=x[I],d[v++]=x[I+1]}i.next=i.next+e+1}else if(0===s.indexOf("POINT_DATA")){for(n=parseInt(s.split(" ")[1],10),i=y(l,i.next),e=4*n*3,p=new Float32Array(3*n),r=i.next,a=0;a<n;a++)p[3*a]=f.getFloat32(r,!1),p[3*a+1]=f.getFloat32(r+4,!1),p[3*a+2]=f.getFloat32(r+8,!1),r+=12;i.next=i.next+e}if((h=i.next)>=l.byteLength)break}var m=new BufferGeometry;return m.setIndex(new BufferAttribute(d,1)),m.addAttribute("position",new BufferAttribute(u,3)),p.length===u.length&&m.addAttribute("normal",new BufferAttribute(p,3)),m}(t)}});export{VTKLoader};