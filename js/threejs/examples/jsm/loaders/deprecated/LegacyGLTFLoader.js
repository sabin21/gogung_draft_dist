import{AddEquation,AlphaFormat,AlwaysDepth,AmbientLight,AnimationClip,AnimationUtils,BackSide,Bone,BufferAttribute,BufferGeometry,ClampToEdgeWrapping,Color,CustomBlending,DirectionalLight,DoubleSide,DstAlphaFactor,DstColorFactor,EqualDepth,FileLoader,FrontSide,GreaterEqualDepth,Group,InterleavedBuffer,InterleavedBufferAttribute,InterpolateDiscrete,InterpolateLinear,LessDepth,LessEqualDepth,Line,LineLoop,LineSegments,LinearFilter,LinearMipmapLinearFilter,LinearMipmapNearestFilter,Loader,LoaderUtils,LuminanceAlphaFormat,LuminanceFormat,Math as _Math,Matrix3,Matrix4,Mesh,MeshBasicMaterial,MeshLambertMaterial,MeshPhongMaterial,MirroredRepeatWrapping,NearestFilter,NearestMipmapLinearFilter,NearestMipmapNearestFilter,NeverDepth,NoBlending,NotEqualDepth,Object3D,OneFactor,OneMinusDstAlphaFactor,OneMinusDstColorFactor,OneMinusSrcAlphaFactor,OneMinusSrcColorFactor,OrthographicCamera,PerspectiveCamera,PointLight,QuaternionKeyframeTrack,RGBAFormat,RGBFormat,RawShaderMaterial,RepeatWrapping,ReverseSubtractEquation,Scene,Skeleton,SkinnedMesh,SpotLight,SrcAlphaFactor,SrcAlphaSaturateFactor,SrcColorFactor,SubtractEquation,Texture,TextureLoader,UniformsUtils,UnsignedByteType,UnsignedShort4444Type,UnsignedShort5551Type,UnsignedShort565Type,Vector2,Vector3,Vector4,VectorKeyframeTrack,ZeroFactor}from"../../../../build/three.module.js";var LegacyGLTFLoader=function(){function e(e){Loader.call(this,e)}function r(){var e={};return{get:function(r){return e[r]},add:function(r,a){e[r]=a},remove:function(r){delete e[r]},removeAll:function(){e={}},update:function(r,a){for(var t in e){var n=e[t];n.update&&n.update(r,a)}}}}function a(e,r){var a={},t=e.material.uniforms;for(var n in t){var i=t[n];if(i.semantic){var s=i.node,o=e;s&&(o=r[s]),a[n]={semantic:i.semantic,sourceNode:o,targetNode:e,uniform:i}}}this.boundUniforms=a,this._m4=new Matrix4}e.prototype=Object.assign(Object.create(Loader.prototype),{constructor:e,load:function(e,r,a,t){var n,i=this;n=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:LoaderUtils.extractUrlBase(e);var s=new FileLoader(i.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.load(e,(function(e){i.parse(e,n,r)}),a,t)},parse:function(e,r,a){var o,c={};LoaderUtils.decodeText(new Uint8Array(e,0,4))===i.magic?(c[t.KHR_BINARY_GLTF]=new s(e),o=c[t.KHR_BINARY_GLTF].content):o=LoaderUtils.decodeText(new Uint8Array(e));var u=JSON.parse(o);u.extensionsUsed&&u.extensionsUsed.indexOf(t.KHR_MATERIALS_COMMON)>=0&&(c[t.KHR_MATERIALS_COMMON]=new n(u)),new O(u,c,{crossOrigin:this.crossOrigin,manager:this.manager,path:r||this.resourcePath||""}).parse((function(e,r,t,n){a({scene:e,scenes:r,cameras:t,animations:n})}))}}),e.Shaders={update:function(){console.warn("THREE.LegacyGLTFLoader.Shaders has been deprecated, and now updates automatically.")}},a.prototype.update=function(e,r){var a=this.boundUniforms;for(var t in a){var n=a[t];switch(n.semantic){case"MODELVIEW":n.uniform.value.multiplyMatrices(r.matrixWorldInverse,n.sourceNode.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var i=n.uniform.value;this._m4.multiplyMatrices(r.matrixWorldInverse,n.sourceNode.matrixWorld),i.getNormalMatrix(this._m4);break;case"PROJECTION":n.uniform.value.copy(r.projectionMatrix);break;case"JOINTMATRIX":for(var s=n.uniform.value,o=0;o<s.length;o++)s[o].getInverse(n.sourceNode.matrixWorld).multiply(n.targetNode.skeleton.bones[o].matrixWorld).multiply(n.targetNode.skeleton.boneInverses[o]).multiply(n.targetNode.bindMatrix);break;default:console.warn("Unhandled shader semantic: "+n.semantic)}}},e.Animations={update:function(){console.warn("THREE.LegacyGLTFLoader.Animation has been deprecated. Use THREE.AnimationMixer instead.")}};var t={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_MATERIALS_COMMON:"KHR_materials_common"};function n(e){this.name=t.KHR_MATERIALS_COMMON,this.lights={};var r=(e.extensions&&e.extensions[t.KHR_MATERIALS_COMMON]||{}).lights||{};for(var a in r){var n,i=r[a],s=i[i.type],o=(new Color).fromArray(s.color);switch(i.type){case"directional":(n=new DirectionalLight(o)).position.set(0,0,1);break;case"point":n=new PointLight(o);break;case"spot":(n=new SpotLight(o)).position.set(0,0,1);break;case"ambient":n=new AmbientLight(o)}n&&(this.lights[a]=n)}}var i={magic:"glTF",version:1,contentFormat:0};function s(e){this.name=t.KHR_BINARY_GLTF;var r=new DataView(e,0,20),a={magic:LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:r.getUint32(4,!0),length:r.getUint32(8,!0),contentLength:r.getUint32(12,!0),contentFormat:r.getUint32(16,!0)};for(var n in i){var s=i[n];if(a[n]!==s)throw new Error('Unsupported glTF-Binary header: Expected "%s" to be "%s".',n,s)}var o=new Uint8Array(e,20,a.contentLength);this.header=a,this.content=LoaderUtils.decodeText(o),this.body=e.slice(20+a.contentLength,a.length)}s.prototype.loadShader=function(e,r){var a=r[e.extensions[t.KHR_BINARY_GLTF].bufferView],n=new Uint8Array(a);return LoaderUtils.decodeText(n)};var o={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,TRIANGLES:4,LINES:1,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,VERTEX_SHADER:35633,FRAGMENT_SHADER:35632},c={5126:Number,35675:Matrix3,35676:Matrix4,35664:Vector2,35665:Vector3,35666:Vector4,35678:Texture},u={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},d={9728:NearestFilter,9729:LinearFilter,9984:NearestMipmapNearestFilter,9985:LinearMipmapNearestFilter,9986:NearestMipmapLinearFilter,9987:LinearMipmapLinearFilter},l={33071:ClampToEdgeWrapping,33648:MirroredRepeatWrapping,10497:RepeatWrapping},p={6406:AlphaFormat,6407:RGBFormat,6408:RGBAFormat,6409:LuminanceFormat,6410:LuminanceAlphaFormat},h={5121:UnsignedByteType,32819:UnsignedShort4444Type,32820:UnsignedShort5551Type,33635:UnsignedShort565Type},f={1028:BackSide,1029:FrontSide},m={512:NeverDepth,513:LessDepth,514:EqualDepth,515:LessEqualDepth,516:GreaterEqualDepth,517:NotEqualDepth,518:GreaterEqualDepth,519:AlwaysDepth},v={32774:AddEquation,32778:SubtractEquation,32779:ReverseSubtractEquation},A={0:ZeroFactor,1:OneFactor,768:SrcColorFactor,769:OneMinusSrcColorFactor,770:SrcAlphaFactor,771:OneMinusSrcAlphaFactor,772:DstAlphaFactor,773:OneMinusDstAlphaFactor,774:DstColorFactor,775:OneMinusDstColorFactor,776:SrcAlphaSaturateFactor},L={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},b={scale:"scale",translation:"position",rotation:"quaternion"},y={LINEAR:InterpolateLinear,STEP:InterpolateDiscrete},M={2884:"CULL_FACE",2929:"DEPTH_TEST",3042:"BLEND",3089:"SCISSOR_TEST",32823:"POLYGON_OFFSET_FILL",32926:"SAMPLE_ALPHA_TO_COVERAGE"};function g(e,r,a){if(!e)return Promise.resolve();var t,n=[];if("[object Array]"===Object.prototype.toString.call(e)){t=[];for(var i=e.length,s=0;s<i;s++)(c=r.call(a||this,e[s],s))&&(n.push(c),c instanceof Promise?c.then(function(e,r){t[e]=r}.bind(this,s)):t[s]=c)}else for(var o in t={},e){var c;e.hasOwnProperty(o)&&(c=r.call(a||this,e[o],o))&&(n.push(c),c instanceof Promise?c.then(function(e,r){t[e]=r}.bind(this,o)):t[o]=c)}return Promise.all(n).then((function(){return t}))}function T(e,r){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:(r||"")+e}function w(e){this.isDeferredShaderMaterial=!0,this.params=e}function O(e,a,t){this.json=e||{},this.extensions=a||{},this.options=t||{},this.cache=new r}return w.prototype.create=function(){var e=UniformsUtils.clone(this.params.uniforms);for(var r in this.params.uniforms){var a=this.params.uniforms[r];a.value instanceof Texture&&(e[r].value=a.value,e[r].value.needsUpdate=!0),e[r].semantic=a.semantic,e[r].node=a.node}return this.params.uniforms=e,new RawShaderMaterial(this.params)},O.prototype._withDependencies=function(e){for(var r={},a=0;a<e.length;a++){var t=e[a],n="load"+t.charAt(0).toUpperCase()+t.slice(1),i=this.cache.get(t);if(void 0!==i)r[t]=i;else if(this[n]){var s=this[n]();this.cache.add(t,s),r[t]=s}}return g(r,(function(e){return e}))},O.prototype.parse=function(e){var r=this.json;this.cache.removeAll(),this._withDependencies(["scenes","cameras","animations"]).then((function(a){var t=[];for(var n in a.scenes)t.push(a.scenes[n]);var i=void 0!==r.scene?a.scenes[r.scene]:t[0],s=[];for(var n in a.cameras){var o=a.cameras[n];s.push(o)}var c=[];for(var n in a.animations)c.push(a.animations[n]);e(i,t,s,c)}))},O.prototype.loadShaders=function(){var e=this.json,r=this.extensions,a=this.options;return this._withDependencies(["bufferViews"]).then((function(n){return g(e.shaders,(function(e){return e.extensions&&e.extensions[t.KHR_BINARY_GLTF]?r[t.KHR_BINARY_GLTF].loadShader(e,n.bufferViews):new Promise((function(r){var t=new FileLoader(a.manager);t.setResponseType("text"),t.load(T(e.uri,a.path),(function(e){r(e)}))}))}))}))},O.prototype.loadBuffers=function(){var e=this.json,r=this.extensions,a=this.options;return g(e.buffers,(function(e,n){return"binary_glTF"===n?r[t.KHR_BINARY_GLTF].body:"arraybuffer"===e.type||void 0===e.type?new Promise((function(r){var t=new FileLoader(a.manager);t.setResponseType("arraybuffer"),t.load(T(e.uri,a.path),(function(e){r(e)}))})):void console.warn("THREE.LegacyGLTFLoader: "+e.type+" buffer type is not supported")}))},O.prototype.loadBufferViews=function(){var e=this.json;return this._withDependencies(["buffers"]).then((function(r){return g(e.bufferViews,(function(e){var a=r.buffers[e.buffer],t=void 0!==e.byteLength?e.byteLength:0;return a.slice(e.byteOffset,e.byteOffset+t)}))}))},O.prototype.loadAccessors=function(){var e=this.json;return this._withDependencies(["bufferViews"]).then((function(r){return g(e.accessors,(function(e){var a=r.bufferViews[e.bufferView],t=L[e.type],n=u[e.componentType],i=n.BYTES_PER_ELEMENT,s=i*t;if(e.byteStride&&e.byteStride!==s){var o=new n(a),c=new InterleavedBuffer(o,e.byteStride/i);return new InterleavedBufferAttribute(c,t,e.byteOffset/i)}return o=new n(a,e.byteOffset,e.count*t),new BufferAttribute(o,t)}))}))},O.prototype.loadTextures=function(){var e=this.json,r=this.options;return this._withDependencies(["bufferViews"]).then((function(a){return g(e.textures,(function(n){if(n.source)return new Promise((function(i){var s=e.images[n.source],o=s.uri,c=!1;if(s.extensions&&s.extensions[t.KHR_BINARY_GLTF]){var u=s.extensions[t.KHR_BINARY_GLTF],f=a.bufferViews[u.bufferView],m=new Blob([f],{type:u.mimeType});o=URL.createObjectURL(m),c=!0}var v=r.manager.getHandler(o);null===v&&(v=new TextureLoader(r.manager)),v.setCrossOrigin(r.crossOrigin),v.load(T(o,r.path),(function(r){if(c&&URL.revokeObjectURL(o),r.flipY=!1,void 0!==n.name&&(r.name=n.name),r.format=void 0!==n.format?p[n.format]:RGBAFormat,void 0!==n.internalFormat&&r.format!==p[n.internalFormat]&&console.warn("THREE.LegacyGLTFLoader: Three.js doesn't support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),r.type=void 0!==n.type?h[n.type]:UnsignedByteType,n.sampler){var a=e.samplers[n.sampler];r.magFilter=d[a.magFilter]||LinearFilter,r.minFilter=d[a.minFilter]||NearestMipmapLinearFilter,r.wrapS=l[a.wrapS]||RepeatWrapping,r.wrapT=l[a.wrapT]||RepeatWrapping}i(r)}),void 0,(function(){c&&URL.revokeObjectURL(o),i()}))}))}))}))},O.prototype.loadMaterials=function(){var e=this.json;return this._withDependencies(["shaders","textures"]).then((function(r){return g(e.materials,(function(a){var n,i,s={},u={};if(a.extensions&&a.extensions[t.KHR_MATERIALS_COMMON]&&(i=a.extensions[t.KHR_MATERIALS_COMMON]),i){var d=["ambient","emission","transparent","transparency","doubleSided"];switch(i.technique){case"BLINN":case"PHONG":n=MeshPhongMaterial,d.push("diffuse","specular","shininess");break;case"LAMBERT":n=MeshLambertMaterial,d.push("diffuse");break;default:n=MeshBasicMaterial}d.forEach((function(e){void 0!==i.values[e]&&(s[e]=i.values[e])})),(i.doubleSided||s.doubleSided)&&(u.side=DoubleSide),(i.transparent||s.transparent)&&(u.transparent=!0,u.opacity=void 0!==s.transparency?s.transparency:1)}else if(void 0===a.technique)n=MeshPhongMaterial,Object.assign(s,a.values);else{n=w;var l=e.techniques[a.technique];u.uniforms={};var p=e.programs[l.program];if(p){u.fragmentShader=r.shaders[p.fragmentShader],u.fragmentShader||(console.warn("ERROR: Missing fragment shader definition:",p.fragmentShader),n=MeshPhongMaterial);var h=r.shaders[p.vertexShader];h||(console.warn("ERROR: Missing vertex shader definition:",p.vertexShader),n=MeshPhongMaterial),u.vertexShader=function(e,r){var a={};for(var t in r.attributes){var n=r.attributes[t],i=(l=r.parameters[n]).type,s=l.semantic;a[t]={type:i,semantic:s}}var o=r.parameters,c=r.attributes,u={};for(var t in a){var d=o[n=c[t]];(s=d.semantic)&&(u[t]=d)}for(var n in u){s=(l=u[n]).semantic;var l,p=new RegExp("\\b"+n+"\\b","g");switch(s){case"POSITION":e=e.replace(p,"position");break;case"NORMAL":e=e.replace(p,"normal");break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":e=e.replace(p,"uv");break;case"TEXCOORD_1":e=e.replace(p,"uv2");break;case"COLOR_0":case"COLOR0":case"COLOR":e=e.replace(p,"color");break;case"WEIGHT":e=e.replace(p,"skinWeight");break;case"JOINT":e=e.replace(p,"skinIndex")}}return e}(h,l);var L=l.uniforms;for(var b in L){var y=L[b],g=l.parameters[y],T=g.type;if(!c[T])throw new Error("Unknown shader uniform param type: "+T);var O,S=g.count;void 0!==a.values&&(O=a.values[y]);var R=new c[T],E=g.semantic,F=g.node;switch(T){case o.FLOAT:R=g.value,"transparency"==y&&(u.transparent=!0),void 0!==O&&(R=O);break;case o.FLOAT_VEC2:case o.FLOAT_VEC3:case o.FLOAT_VEC4:case o.FLOAT_MAT3:g&&g.value&&R.fromArray(g.value),O&&R.fromArray(O);break;case o.FLOAT_MAT2:console.warn("FLOAT_MAT2 is not a supported uniform type");break;case o.FLOAT_MAT4:if(S){R=new Array(S);for(var _=0;_<S;_++)R[_]=new c[T];if(g&&g.value){var x=g.value;R.fromArray(x)}O&&R.fromArray(O)}else{if(g&&g.value){var N=g.value;R.fromArray(N)}O&&R.fromArray(O)}break;case o.SAMPLER_2D:R=void 0!==O?r.textures[O]:void 0!==g.value?r.textures[g.value]:null}u.uniforms[b]={value:R,semantic:E,node:F}}for(var D=l.states||{},C=D.enable||[],I=D.functions||{},k=!1,U=!1,B=!1,G=0,H=C.length;G<H;G++){var P=C[G];switch(M[P]){case"CULL_FACE":k=!0;break;case"DEPTH_TEST":U=!0;break;case"BLEND":B=!0;break;case"SCISSOR_TEST":case"POLYGON_OFFSET_FILL":case"SAMPLE_ALPHA_TO_COVERAGE":break;default:throw new Error("Unknown technique.states.enable: "+P)}}u.side=k?void 0!==I.cullFace?f[I.cullFace]:FrontSide:DoubleSide,u.depthTest=U,u.depthFunc=void 0!==I.depthFunc?m[I.depthFunc]:LessDepth,u.depthWrite=void 0===I.depthMask||I.depthMask[0],u.blending=B?CustomBlending:NoBlending,u.transparent=B;var j=I.blendEquationSeparate;void 0!==j?(u.blendEquation=v[j[0]],u.blendEquationAlpha=v[j[1]]):(u.blendEquation=AddEquation,u.blendEquationAlpha=AddEquation);var V=I.blendFuncSeparate;void 0!==V?(u.blendSrc=A[V[0]],u.blendDst=A[V[1]],u.blendSrcAlpha=A[V[2]],u.blendDstAlpha=A[V[3]]):(u.blendSrc=OneFactor,u.blendDst=ZeroFactor,u.blendSrcAlpha=OneFactor,u.blendDstAlpha=ZeroFactor)}}Array.isArray(s.diffuse)?u.color=(new Color).fromArray(s.diffuse):"string"==typeof s.diffuse&&(u.map=r.textures[s.diffuse]),delete u.diffuse,"string"==typeof s.reflective&&(u.envMap=r.textures[s.reflective]),"string"==typeof s.bump&&(u.bumpMap=r.textures[s.bump]),Array.isArray(s.emission)?n===MeshBasicMaterial?u.color=(new Color).fromArray(s.emission):u.emissive=(new Color).fromArray(s.emission):"string"==typeof s.emission&&(n===MeshBasicMaterial?u.map=r.textures[s.emission]:u.emissiveMap=r.textures[s.emission]),Array.isArray(s.specular)?u.specular=(new Color).fromArray(s.specular):"string"==typeof s.specular&&(u.specularMap=r.textures[s.specular]),void 0!==s.shininess&&(u.shininess=s.shininess);var q=new n(u);return void 0!==a.name&&(q.name=a.name),q}))}))},O.prototype.loadMeshes=function(){var e=this.json;return this._withDependencies(["accessors","materials"]).then((function(r){return g(e.meshes,(function(a){var t=new Group;void 0!==a.name&&(t.name=a.name),a.extras&&(t.userData=a.extras);var n=a.primitives||[];for(var i in n){var s=n[i];if(s.mode===o.TRIANGLES||void 0===s.mode){var c=new BufferGeometry,u=s.attributes;for(var d in u){if(!(m=u[d]))return;var l=r.accessors[m];switch(d){case"POSITION":c.addAttribute("position",l);break;case"NORMAL":c.addAttribute("normal",l);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":c.addAttribute("uv",l);break;case"TEXCOORD_1":c.addAttribute("uv2",l);break;case"COLOR_0":case"COLOR0":case"COLOR":c.addAttribute("color",l);break;case"WEIGHT":c.addAttribute("skinWeight",l);break;case"JOINT":c.addAttribute("skinIndex",l);break;default:if(!s.material)break;if(!(f=e.materials[s.material]).technique)break;var p=e.techniques[f.technique].parameters||{};for(var h in p)p[h].semantic===d&&c.addAttribute(h,l)}}s.indices&&c.setIndex(r.accessors[s.indices]);var f=void 0!==r.materials?r.materials[s.material]:new MeshPhongMaterial({color:0,emissive:8947848,specular:0,shininess:0,transparent:!1,depthTest:!0,side:FrontSide});(v=new Mesh(c,f)).castShadow=!0,v.name="0"===i?t.name:t.name+i,s.extras&&(v.userData=s.extras),t.add(v)}else if(s.mode===o.LINES){for(var d in c=new BufferGeometry,u=s.attributes){var m;if(!(m=u[d]))return;switch(l=r.accessors[m],d){case"POSITION":c.addAttribute("position",l);break;case"COLOR_0":case"COLOR0":case"COLOR":c.addAttribute("color",l)}}var v;f=r.materials[s.material],s.indices?(c.setIndex(r.accessors[s.indices]),v=new LineSegments(c,f)):v=new Line(c,f),v.name="0"===i?t.name:t.name+i,s.extras&&(v.userData=s.extras),t.add(v)}else console.warn("Only triangular and line primitives are supported")}return t}))}))},O.prototype.loadCameras=function(){return g(this.json.cameras,(function(e){if("perspective"==e.type&&e.perspective){var r=e.perspective.yfov,a=void 0!==e.perspective.aspectRatio?e.perspective.aspectRatio:1,t=r*a,n=new PerspectiveCamera(_Math.radToDeg(t),a,e.perspective.znear||1,e.perspective.zfar||2e6);return void 0!==e.name&&(n.name=e.name),e.extras&&(n.userData=e.extras),n}if("orthographic"==e.type&&e.orthographic)return n=new OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar),void 0!==e.name&&(n.name=e.name),e.extras&&(n.userData=e.extras),n}))},O.prototype.loadSkins=function(){var e=this.json;return this._withDependencies(["accessors"]).then((function(r){return g(e.skins,(function(e){var a=new Matrix4;return void 0!==e.bindShapeMatrix&&a.fromArray(e.bindShapeMatrix),{bindShapeMatrix:a,jointNames:e.jointNames,inverseBindMatrices:r.accessors[e.inverseBindMatrices]}}))}))},O.prototype.loadAnimations=function(){var e=this.json;return this._withDependencies(["accessors","nodes"]).then((function(r){return g(e.animations,(function(e,a){var t=[];for(var n in e.channels){var i=e.channels[n],s=e.samplers[i.sampler];if(s){var o=i.target,c=o.id,u=void 0!==e.parameters?e.parameters[s.input]:s.input,d=void 0!==e.parameters?e.parameters[s.output]:s.output,l=r.accessors[u],p=r.accessors[d],h=r.nodes[c];if(h){h.updateMatrix(),h.matrixAutoUpdate=!0;var f=b[o.path]===b.rotation?QuaternionKeyframeTrack:VectorKeyframeTrack,m=h.name?h.name:h.uuid,v=void 0!==s.interpolation?y[s.interpolation]:InterpolateLinear;t.push(new f(m+"."+b[o.path],AnimationUtils.arraySlice(l.array,0),AnimationUtils.arraySlice(p.array,0),v))}}}return c=void 0!==e.name?e.name:"animation_"+a,new AnimationClip(c,void 0,t)}))}))},O.prototype.loadNodes=function(){var e=this.json,r=this.extensions,a=this;return g(e.nodes,(function(e){var r,a=new Matrix4;return e.jointName?((r=new Bone).name=void 0!==e.name?e.name:e.jointName,r.jointName=e.jointName):(r=new Object3D,void 0!==e.name&&(r.name=e.name)),e.extras&&(r.userData=e.extras),void 0!==e.matrix?(a.fromArray(e.matrix),r.applyMatrix(a)):(void 0!==e.translation&&r.position.fromArray(e.translation),void 0!==e.rotation&&r.quaternion.fromArray(e.rotation),void 0!==e.scale&&r.scale.fromArray(e.scale)),r})).then((function(n){return a._withDependencies(["meshes","skins","cameras"]).then((function(a){return g(n,(function(i,s){var o=e.nodes[s];if(void 0!==o.meshes)for(var c in o.meshes){var u=o.meshes[c],d=a.meshes[u];if(void 0!==d)for(var l in d.children){var p,h=d.children[l],f=h.material,m=h.geometry,v=h.userData,A=h.name;switch(f.isDeferredShaderMaterial?f=L=f.create():L=f,h.type){case"LineSegments":h=new LineSegments(m,L);break;case"LineLoop":h=new LineLoop(m,L);break;case"Line":h=new Line(m,L);break;default:h=new Mesh(m,L)}if(h.castShadow=!0,h.userData=v,h.name=A,o.skin&&(p=a.skins[o.skin]),p){var L,b=function(e){for(var r=Object.keys(n),a=0,t=r.length;a<t;a++){var i=n[r[a]];if(i.jointName===e)return i}return null},y=m;(L=f).skinning=!0,(h=new SkinnedMesh(y,L)).castShadow=!0,h.userData=v,h.name=A;for(var M=[],g=[],T=0,w=p.jointNames.length;T<w;T++){var O=p.jointNames[T],S=b(O);if(S){M.push(S);var R=p.inverseBindMatrices.array,E=(new Matrix4).fromArray(R,16*T);g.push(E)}else console.warn("WARNING: joint: '"+O+"' could not be found")}h.bind(new Skeleton(M,g),p.bindShapeMatrix);var F=function(r,a,t){var i=r[t];if(void 0!==i)for(var s=0,o=i.length;s<o;s++){var c=i[s],u=n[c],d=e.nodes[c];void 0!==u&&!0===u.isBone&&void 0!==d&&(a.add(u),F(d,u,"children"))}};F(o,h,"skeletons")}i.add(h)}else console.warn("LegacyGLTFLoader: Couldn't find node \""+u+'".')}if(void 0!==o.camera){var _=a.cameras[o.camera];i.add(_)}if(o.extensions&&o.extensions[t.KHR_MATERIALS_COMMON]&&o.extensions[t.KHR_MATERIALS_COMMON].light){var x=r[t.KHR_MATERIALS_COMMON].lights[o.extensions[t.KHR_MATERIALS_COMMON].light];i.add(x)}return i}))}))}))},O.prototype.loadScenes=function(){var e=this.json;function r(a,t,n){var i=n[a];t.add(i);var s=e.nodes[a];if(s.children)for(var o=s.children,c=0,u=o.length;c<u;c++)r(o[c],i,n)}return this._withDependencies(["nodes"]).then((function(t){return g(e.scenes,(function(e){var n=new Scene;void 0!==e.name&&(n.name=e.name),e.extras&&(n.userData=e.extras);for(var i=e.nodes||[],s=0,o=i.length;s<o;s++)r(i[s],n,t.nodes);return n.traverse((function(e){e.material&&e.material.isRawShaderMaterial&&(e.gltfShader=new a(e,t.nodes),e.onBeforeRender=function(e,r,a){this.gltfShader.update(r,a)})})),n}))}))},e}();export{LegacyGLTFLoader};