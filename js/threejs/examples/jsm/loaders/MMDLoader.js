import{AddOperation,AnimationClip,Bone,BufferGeometry,Color,CustomBlending,DoubleSide,DstAlphaFactor,Euler,FileLoader,Float32BufferAttribute,FrontSide,Interpolant,Loader,LoaderUtils,MeshToonMaterial,MultiplyOperation,NearestFilter,NumberKeyframeTrack,OneMinusSrcAlphaFactor,Quaternion,QuaternionKeyframeTrack,RepeatWrapping,Skeleton,SkinnedMesh,SphericalReflectionMapping,SrcAlphaFactor,TextureLoader,Uint16BufferAttribute,Vector3,VectorKeyframeTrack}from"../../../build/three.module.js";import{TGALoader}from"../loaders/TGALoader.js";import{MMDParser}from"../libs/mmdparser.module.js";var MMDLoader=function(){function e(e){Loader.call(this,e),this.loader=new FileLoader(this.manager),this.parser=null,this.meshBuilder=new r(this.manager),this.animationBuilder=new o}e.prototype=Object.assign(Object.create(Loader.prototype),{constructor:e,setAnimationPath:function(e){return this.animationPath=e,this},load:function(e,t,r,a){var n,o=this.meshBuilder.setCrossOrigin(this.crossOrigin);n=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:LoaderUtils.extractUrlBase(e);var i=this._extractExtension(e).toLowerCase();"pmd"===i||"pmx"===i?this["pmd"===i?"loadPMD":"loadPMX"](e,(function(e){t(o.build(e,n,r,a))}),r,a):a&&a(new Error("THREE.MMDLoader: Unknown model file extension ."+i+"."))},loadAnimation:function(e,t,r,a,n){var o=this.animationBuilder;this.loadVMD(e,(function(e){r(t.isCamera?o.buildCameraAnimation(e):o.build(e,t))}),a,n)},loadWithAnimation:function(e,t,r,a,n){var o=this;this.load(e,(function(e){o.loadAnimation(t,e,(function(t){r({mesh:e,animation:t})}),a,n)}),a,n)},loadPMD:function(e,t,r,a){var n=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").load(e,(function(e){t(n.parsePmd(e,!0))}),r,a)},loadPMX:function(e,t,r,a){var n=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").load(e,(function(e){t(n.parsePmx(e,!0))}),r,a)},loadVMD:function(e,t,r,a){var n=Array.isArray(e)?e:[e],o=[],i=n.length,s=this._getParser();this.loader.setMimeType(void 0).setPath(this.animationPath).setResponseType("arraybuffer");for(var A=0,l=n.length;A<l;A++)this.loader.load(n[A],(function(e){o.push(s.parseVmd(e,!0)),o.length===i&&t(s.mergeVmds(o))}),r,a)},loadVPD:function(e,t,r,a,n){var o=this._getParser();this.loader.setMimeType(t?void 0:"text/plain; charset=shift_jis").setPath(this.animationPath).setResponseType("text").load(e,(function(e){r(o.parseVpd(e,!0))}),a,n)},_extractExtension:function(e){var t=e.lastIndexOf(".");return t<0?"":e.slice(t+1)},_getParser:function(){if(null===this.parser){if(void 0===MMDParser)throw new Error("THREE.MMDLoader: Import MMDParser https://github.com/takahirox/mmd-parser");this.parser=new MMDParser.Parser}return this.parser}});var t=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="];function r(e){this.geometryBuilder=new a,this.materialBuilder=new n(e)}function a(){}function n(e){this.manager=e,this.textureLoader=new TextureLoader(this.manager),this.tgaLoader=null}function o(){}function i(e,t,r,a,n){Interpolant.call(this,e,t,r,a),this.interpolationParams=n}return r.prototype={constructor:r,crossOrigin:"anonymous",setCrossOrigin:function(e){return this.crossOrigin=e,this},build:function(e,t,r,a){var n=this.geometryBuilder.build(e),o=this.materialBuilder.setCrossOrigin(this.crossOrigin).setResourcePath(t).build(e,n,r,a),i=new SkinnedMesh(n,o),s=new Skeleton(function(e){var t,r,a,n,o=e.geometry,i=[];if(o&&void 0!==o.bones){for(a=0,n=o.bones.length;a<n;a++)r=o.bones[a],t=new Bone,i.push(t),t.name=r.name,t.position.fromArray(r.pos),t.quaternion.fromArray(r.rotq),void 0!==r.scl&&t.scale.fromArray(r.scl);for(a=0,n=o.bones.length;a<n;a++)-1!==(r=o.bones[a]).parent&&null!==r.parent&&void 0!==i[r.parent]?i[r.parent].add(i[a]):e.add(i[a])}return e.updateMatrixWorld(!0),i}(i));return i.bind(s),i}},a.prototype={constructor:a,build:function(e){for(var t=[],r=[],a=[],n=[],o=[],i=[],s=[],A=[],l=[],u=[],h=[],p=[],d=[],f=[],m=0,g={},c=0;c<e.metadata.vertexCount;c++){for(var v=e.vertices[c],C=0,b=v.position.length;C<b;C++)t.push(v.position[C]);for(C=0,b=v.normal.length;C<b;C++)a.push(v.normal[C]);for(C=0,b=v.uv.length;C<b;C++)r.push(v.uv[C]);for(C=0;C<4;C++)s.push(v.skinIndices.length-1>=C?v.skinIndices[C]:0);for(C=0;C<4;C++)A.push(v.skinWeights.length-1>=C?v.skinWeights[C]:0)}for(c=0;c<e.metadata.faceCount;c++){var y=e.faces[c];for(C=0,b=y.indices.length;C<b;C++)n.push(y.indices[C])}for(c=0;c<e.metadata.materialCount;c++){var B=e.materials[c];o.push({offset:3*m,count:3*B.faceCount}),m+=B.faceCount}for(c=0;c<e.metadata.rigidBodyCount;c++){var x=e.rigidBodies[c],M=g[x.boneIndex];M=void 0===M?x.type:Math.max(x.type,M),g[x.boneIndex]=M}for(c=0;c<e.metadata.boneCount;c++)-1!==(z={parent:(P=e.bones[c]).parentIndex,name:P.name,pos:P.position.slice(0,3),rotq:[0,0,0,1],scl:[1,1,1],rigidBodyType:void 0!==g[c]?g[c]:-1}).parent&&(z.pos[0]-=e.bones[z.parent].position[0],z.pos[1]-=e.bones[z.parent].position[1],z.pos[2]-=e.bones[z.parent].position[2]),i.push(z);if("pmd"===e.metadata.format)for(c=0;c<e.metadata.ikCount;c++){var T={target:(I=e.iks[c]).target,effector:I.effector,iteration:I.iteration,maxAngle:4*I.maxAngle,links:[]};for(C=0,b=I.links.length;C<b;C++)(R={}).index=I.links[C].index,R.enabled=!0,e.bones[R.index].name.indexOf("ひざ")>=0&&(R.limitation=new Vector3(1,0,0)),T.links.push(R);h.push(T)}else for(c=0;c<e.metadata.boneCount;c++){var I;if(void 0!==(I=e.bones[c].ik)){for(T={target:c,effector:I.effector,iteration:I.iteration,maxAngle:I.maxAngle,links:[]},C=0,b=I.links.length;C<b;C++){var R;if((R={}).index=I.links[C].index,R.enabled=!0,1===I.links[C].angleLimitation){var w=I.links[C].lowerLimitationAngle,E=I.links[C].upperLimitationAngle,k=-E[0],Q=-E[1];E[0]=-w[0],E[1]=-w[1],w[0]=k,w[1]=Q,R.rotationMin=(new Vector3).fromArray(w),R.rotationMax=(new Vector3).fromArray(E)}T.links.push(R)}h.push(T)}}if("pmx"===e.metadata.format){for(c=0;c<e.metadata.boneCount;c++){var P,U=(P=e.bones[c]).grant;void 0!==U&&(T={index:c,parentIndex:U.parentIndex,ratio:U.ratio,isLocal:U.isLocal,affectRotation:U.affectRotation,affectPosition:U.affectPosition,transformationClass:P.transformationClass},p.push(T))}p.sort((function(e,t){return e.transformationClass-t.transformationClass}))}function L(t,r,a){for(var n=0;n<r.elementCount;n++){var o,i=r.elements[n];o="pmd"===e.metadata.format?e.morphs[0].elements[i.index].index:i.index,t.array[3*o+0]+=i.position[0]*a,t.array[3*o+1]+=i.position[1]*a,t.array[3*o+2]+=i.position[2]*a}}for(c=0;c<e.metadata.morphCount;c++){var O=e.morphs[c],V={name:O.name},S=new Float32BufferAttribute(3*e.metadata.vertexCount,3);for(S.name=O.name,C=0;C<3*e.metadata.vertexCount;C++)S.array[C]=t[C];if("pmd"===e.metadata.format)0!==c&&L(S,O,1);else if(0===O.type)for(C=0;C<O.elementCount;C++){var D=e.morphs[O.elements[C].index],F=O.elements[C].ratio;1===D.type&&L(S,D,F)}else 1===O.type?L(S,O,1):2===O.type||3===O.type||4===O.type||5===O.type||6===O.type||7===O.type||O.type;l.push(V),u.push(S)}for(c=0;c<e.metadata.rigidBodyCount;c++){var N=e.rigidBodies[c];for(var Y in V={},N)V[Y]=N[Y];if("pmx"===e.metadata.format&&-1!==V.boneIndex){var z=e.bones[V.boneIndex];V.position[0]-=z.position[0],V.position[1]-=z.position[1],V.position[2]-=z.position[2]}d.push(V)}for(c=0;c<e.metadata.constraintCount;c++){var K=e.constraints[c];for(var Y in V={},K)V[Y]=K[Y];var J=d[V.rigidBodyIndex1],W=d[V.rigidBodyIndex2];0!==J.type&&2===W.type&&-1!==J.boneIndex&&-1!==W.boneIndex&&e.bones[W.boneIndex].parentIndex===J.boneIndex&&(W.type=1),f.push(V)}var G=new BufferGeometry;G.addAttribute("position",new Float32BufferAttribute(t,3)),G.addAttribute("normal",new Float32BufferAttribute(a,3)),G.addAttribute("uv",new Float32BufferAttribute(r,2)),G.addAttribute("skinIndex",new Uint16BufferAttribute(s,4)),G.addAttribute("skinWeight",new Float32BufferAttribute(A,4)),G.setIndex(n),c=0;for(var j=o.length;c<j;c++)G.addGroup(o[c].offset,o[c].count,c);return G.bones=i,G.morphTargets=l,G.morphAttributes.position=u,G.userData.MMD={bones:i,iks:h,grants:p,rigidBodies:d,constraints:f,format:e.metadata.format},G.computeBoundingSphere(),G}},n.prototype={constructor:n,crossOrigin:"anonymous",resourcePath:void 0,setCrossOrigin:function(e){return this.crossOrigin=e,this},setResourcePath:function(e){return this.resourcePath=e,this},build:function(e,t){var r=[],a={};this.textureLoader.setCrossOrigin(this.crossOrigin);for(var n=0;n<e.metadata.materialCount;n++){var o=e.materials[n],i={userData:{}};if(void 0!==o.name&&(i.name=o.name),i.color=(new Color).fromArray(o.diffuse),i.opacity=o.diffuse[3],i.specular=(new Color).fromArray(o.specular),i.emissive=(new Color).fromArray(o.ambient),i.shininess=Math.max(o.shininess,1e-4),i.transparent=1!==i.opacity,i.skinning=t.bones.length>0,i.morphTargets=t.morphTargets.length>0,i.fog=!0,i.blending=CustomBlending,i.blendSrc=SrcAlphaFactor,i.blendDst=OneMinusSrcAlphaFactor,i.blendSrcAlpha=SrcAlphaFactor,i.blendDstAlpha=DstAlphaFactor,"pmx"===e.metadata.format&&1==(1&o.flag)?i.side=DoubleSide:i.side=1===i.opacity?FrontSide:DoubleSide,"pmd"===e.metadata.format){if(o.fileName){var s=o.fileName.split("*");if(i.map=this._loadTexture(s[0],a),s.length>1){var A=s[1].slice(-4).toLowerCase();i.envMap=this._loadTexture(s[1],a,{sphericalReflectionMapping:!0}),i.combine=".sph"===A?MultiplyOperation:AddOperation}}var l=-1===o.toonIndex?"toon00.bmp":e.toonTextures[o.toonIndex].fileName;i.gradientMap=this._loadTexture(l,a,{isToonTexture:!0,isDefaultToonTexture:this._isDefaultToonTexture(l)}),i.userData.outlineParameters={thickness:1===o.edgeFlag?.003:0,color:[0,0,0],alpha:1,visible:1===o.edgeFlag}}else{var u;-1!==o.textureIndex&&(i.map=this._loadTexture(e.textures[o.textureIndex],a)),-1===o.envTextureIndex||1!==o.envFlag&&2!=o.envFlag||(i.envMap=this._loadTexture(e.textures[o.envTextureIndex],a,{sphericalReflectionMapping:!0}),i.combine=1===o.envFlag?MultiplyOperation:AddOperation),-1===o.toonIndex||0!==o.toonFlag?(l="toon"+("0"+(o.toonIndex+1)).slice(-2)+".bmp",u=!0):(l=e.textures[o.toonIndex],u=!1),i.gradientMap=this._loadTexture(l,a,{isToonTexture:!0,isDefaultToonTexture:u}),i.userData.outlineParameters={thickness:o.edgeSize/300,color:o.edgeColor.slice(0,3),alpha:o.edgeColor[3],visible:0!=(16&o.flag)&&o.edgeSize>0}}void 0!==i.map&&(i.transparent||this._checkImageTransparency(i.map,t,n),i.emissive.multiplyScalar(.2)),r.push(new MeshToonMaterial(i))}if("pmx"===e.metadata.format){function h(e,t){for(var r=0,a=e.length;r<a;r++){var n=e[r];if(-1!==n.index){var o=t[n.index];o.opacity!==n.diffuse[3]&&(o.transparent=!0)}}}n=0;for(var p=e.morphs.length;n<p;n++){var d=e.morphs[n],f=d.elements;if(0===d.type)for(var m=0,g=f.length;m<g;m++){var c=e.morphs[f[m].index];8===c.type&&h(c.elements,r)}else 8===d.type&&h(f,r)}}return r},_getTGALoader:function(){if(null===this.tgaLoader){if(void 0===TGALoader)throw new Error("THREE.MMDLoader: Import TGALoader");this.tgaLoader=new TGALoader(this.manager)}return this.tgaLoader},_isDefaultToonTexture:function(e){return 10===e.length&&/toon(10|0[0-9])\.bmp/.test(e)},_loadTexture:function(e,r,a,n,o){var i,s=this;if(!0===(a=a||{}).isDefaultToonTexture){var A;try{A=parseInt(e.match("toon([0-9]{2}).bmp$")[1])}catch(t){console.warn("THREE.MMDLoader: "+e+" seems like a not right default texture path. Using toon00.bmp instead."),A=0}i=t[A]}else i=this.resourcePath+e;if(void 0!==r[i])return r[i];var l=this.manager.getHandler(i);null===l&&(l=".tga"===e.slice(-4).toLowerCase()?this._getTGALoader():this.textureLoader);var u=l.load(i,(function(e){!0===a.isToonTexture&&(e.image=s._getRotatedImage(e.image),e.magFilter=NearestFilter,e.minFilter=NearestFilter),e.flipY=!1,e.wrapS=RepeatWrapping,e.wrapT=RepeatWrapping;for(var t=0;t<u.readyCallbacks.length;t++)u.readyCallbacks[t](u);delete u.readyCallbacks}),n,o);return!0===a.sphericalReflectionMapping&&(u.mapping=SphericalReflectionMapping),u.readyCallbacks=[],r[i]=u,u},_getRotatedImage:function(e){var t=document.createElement("canvas"),r=t.getContext("2d"),a=e.width,n=e.height;return t.width=a,t.height=n,r.clearRect(0,0,a,n),r.translate(a/2,n/2),r.rotate(.5*Math.PI),r.translate(-a/2,-n/2),r.drawImage(e,0,0),r.getImageData(0,0,a,n)},_checkImageTransparency:function(e,t,r){e.readyCallbacks.push((function(a){function n(e,t){var r=e.width,a=e.height,n=Math.round(t.x*r)%r,o=Math.round(t.y*a)%a;n<0&&(n+=r),o<0&&(o+=a);var i=o*r+n;return e.data[4*i+3]}var o=void 0!==a.image.data?a.image:function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var r=t.getContext("2d");return r.drawImage(e,0,0),r.getImageData(0,0,t.width,t.height)}(a.image),i=t.groups[r];(function(e,t,r){var a=e.width,o=e.height;if(e.data.length/(a*o)!=4)return!1;for(var i=0;i<r.length;i+=3){for(var s={x:0,y:0},A=0;A<3;A++){var l=r[3*i+A],u={x:t[2*l+0],y:t[2*l+1]};if(n(e,u)<253)return!0;s.x+=u.x,s.y+=u.y}if(s.x/=3,s.y/=3,n(e,s)<253)return!0}return!1})(o,t.attributes.uv.array,t.index.array.slice(i.start,i.start+i.count))&&(e.transparent=!0)}))}},o.prototype={constructor:o,build:function(e,t){for(var r=this.buildSkeletalAnimation(e,t).tracks,a=this.buildMorphAnimation(e,t).tracks,n=0,o=a.length;n<o;n++)r.push(a[n]);return new AnimationClip("",-1,r)},buildSkeletalAnimation:function(e,t){function r(e,t,r){e.push(t[r+0]/127),e.push(t[r+8]/127),e.push(t[r+4]/127),e.push(t[r+12]/127)}for(var a=[],n={},o=t.skeleton.bones,i={},s=0,A=o.length;s<A;s++)i[o[s].name]=!0;for(s=0;s<e.metadata.motionCount;s++){var l=e.motions[s],u=l.boneName;void 0!==i[u]&&(n[u]=n[u]||[],n[u].push(l))}for(var h in n){var p=n[h];p.sort((function(e,t){return e.frameNum-t.frameNum}));var d=[],f=[],m=[],g=[],c=[],v=t.skeleton.getBoneByName(h).position.toArray();for(s=0,A=p.length;s<A;s++){var C=p[s].frameNum/30,b=p[s].position,y=p[s].rotation,B=p[s].interpolation;d.push(C);for(var x=0;x<3;x++)f.push(v[x]+b[x]);for(x=0;x<4;x++)m.push(y[x]);for(x=0;x<3;x++)r(g,B,x);r(c,B,3)}var M=".bones["+h+"]";a.push(this._createTrack(M+".position",VectorKeyframeTrack,d,f,g)),a.push(this._createTrack(M+".quaternion",QuaternionKeyframeTrack,d,m,c))}return new AnimationClip("",-1,a)},buildMorphAnimation:function(e,t){for(var r=[],a={},n=t.morphTargetDictionary,o=0;o<e.metadata.morphCount;o++){var i=e.morphs[o],s=i.morphName;void 0!==n[s]&&(a[s]=a[s]||[],a[s].push(i))}for(var A in a){var l=a[A];l.sort((function(e,t){return e.frameNum-t.frameNum}));for(var u=[],h=[],p=(o=0,l.length);o<p;o++)u.push(l[o].frameNum/30),h.push(l[o].weight);r.push(new NumberKeyframeTrack(".morphTargetInfluences["+n[A]+"]",u,h))}return new AnimationClip("",-1,r)},buildCameraAnimation:function(e){function t(e,t){e.push(t.x),e.push(t.y),e.push(t.z)}function r(e,t,r){e.push(t[4*r+0]/127),e.push(t[4*r+1]/127),e.push(t[4*r+2]/127),e.push(t[4*r+3]/127)}var a=[],n=void 0===e.cameras?[]:e.cameras.slice();n.sort((function(e,t){return e.frameNum-t.frameNum}));for(var o,i,s=[],A=[],l=[],u=[],h=[],p=[],d=[],f=[],m=[],g=new Quaternion,c=new Euler,v=new Vector3,C=new Vector3,b=0,y=n.length;b<y;b++){var B=n[b],x=B.frameNum/30,M=B.position,T=B.rotation,I=B.distance,R=B.fov,w=B.interpolation;s.push(x),v.set(0,0,-I),C.set(M[0],M[1],M[2]),c.set(-T[0],-T[1],-T[2]),g.setFromEuler(c),v.add(C),v.applyQuaternion(g),t(A,C),(o=l).push((i=g).x),o.push(i.y),o.push(i.z),o.push(i.w),t(u,v),h.push(R);for(var E=0;E<3;E++)r(p,w,E);for(r(d,w,3),E=0;E<3;E++)r(f,w,4);r(m,w,5)}return(a=[]).push(this._createTrack("target.position",VectorKeyframeTrack,s,A,p)),a.push(this._createTrack(".quaternion",QuaternionKeyframeTrack,s,l,d)),a.push(this._createTrack(".position",VectorKeyframeTrack,s,u,f)),a.push(this._createTrack(".fov",NumberKeyframeTrack,s,h,m)),new AnimationClip("",-1,a)},_createTrack:function(e,t,r,a,n){if(r.length>2){r=r.slice(),a=a.slice(),n=n.slice();for(var o=a.length/r.length,s=n.length/r.length,A=1,l=2,u=r.length;l<u;l++){for(var h=0;h<o;h++)if(a[A*o+h]!==a[(A-1)*o+h]||a[A*o+h]!==a[l*o+h]){A++;break}if(l>A){for(r[A]=r[l],h=0;h<o;h++)a[A*o+h]=a[l*o+h];for(h=0;h<s;h++)n[A*s+h]=n[l*s+h]}}r.length=A+1,a.length=(A+1)*o,n.length=(A+1)*s}var p=new t(e,r,a);return p.createInterpolant=function(e){return new i(this.times,this.values,this.getValueSize(),e,new Float32Array(n))},p}},i.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:i,interpolate_:function(e,t,r,a){var n=this.resultBuffer,o=this.sampleValues,i=this.valueSize,s=this.interpolationParams,A=e*i,l=A-i,u=a-t<.05?0:(r-t)/(a-t);if(4===i){var h=s[4*e+0],p=s[4*e+1],d=s[4*e+2],f=s[4*e+3],m=this._calculate(h,p,d,f,u);Quaternion.slerpFlat(n,0,o,l,o,A,m)}else if(3===i)for(var g=0;g!==i;++g)h=s[12*e+4*g+0],p=s[12*e+4*g+1],d=s[12*e+4*g+2],f=s[12*e+4*g+3],m=this._calculate(h,p,d,f,u),n[g]=o[l+g]*(1-m)+o[A+g]*m;else h=s[4*e+0],p=s[4*e+1],d=s[4*e+2],f=s[4*e+3],m=this._calculate(h,p,d,f,u),n[0]=o[l]*(1-m)+o[A]*m;return n},_calculate:function(e,t,r,a,n){for(var o,i,s,A=.5,l=A,u=1-l,h=Math,p=0;p<15;p++){var d=(o=3*u*u*l)*e+(i=3*u*l*l)*t+(s=l*l*l)-n;if(h.abs(d)<1e-5)break;A/=2,u=1-(l+=d<0?A:-A)}return o*r+i*a+s}}),e}();export{MMDLoader};