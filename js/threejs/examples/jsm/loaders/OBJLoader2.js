import{FileLoader,Object3D,Loader}from"../../../build/three.module.js";import{OBJLoader2Parser}from"./obj2/worker/parallel/OBJLoader2Parser.js";import{MeshReceiver}from"./obj2/shared/MeshReceiver.js";import{MaterialHandler}from"./obj2/shared/MaterialHandler.js";const OBJLoader2=function(e){Loader.call(this,e),this.parser=new OBJLoader2Parser,this.modelName="",this.instanceNo=0,this.baseObject3d=new Object3D,this.materialHandler=new MaterialHandler,this.meshReceiver=new MeshReceiver(this.materialHandler);let t=this;this.parser.setCallbackOnAssetAvailable((function(e){t._onAssetAvailable(e)}))};OBJLoader2.OBJLOADER2_VERSION="3.1.0",console.info("Using OBJLoader2 version: "+OBJLoader2.OBJLOADER2_VERSION),OBJLoader2.prototype=Object.assign(Object.create(Loader.prototype),{constructor:OBJLoader2,setLogging:function(e,t){return this.parser.setLogging(e,t),this},setMaterialPerSmoothingGroup:function(e){return this.parser.setMaterialPerSmoothingGroup(e),this},setUseOAsMesh:function(e){return this.parser.setUseOAsMesh(e),this},setUseIndices:function(e){return this.parser.setUseIndices(e),this},setDisregardNormals:function(e){return this.parser.setDisregardNormals(e),this},setModelName:function(e){return this.modelName=e||this.modelName,this},setBaseObject3d:function(e){return this.baseObject3d=null==e?this.baseObject3d:e,this},addMaterials:function(e){return this.materialHandler.addMaterials(e),this},setCallbackOnAssetAvailable:function(e){return this.parser.setCallbackOnAssetAvailable(e),this},setCallbackOnProgress:function(e){return this.parser.setCallbackOnProgress(e),this},setCallbackOnError:function(e){return this.parser.setCallbackOnError(e),this},setCallbackOnLoad:function(e){return this.parser.setCallbackOnLoad(e),this},setCallbackOnMeshAlter:function(e){return this.meshReceiver._setCallbacks(this.parser.callbacks.onProgress,e),this},setCallbackOnLoadMaterials:function(e){return this.materialHandler._setCallbacks(e),this},load:function(e,t,r,a,s){let n=this;if(!(null!=t&&t instanceof Function)){let e="onLoad is not a function! Aborting...";throw n.parser.callbacks.onError(e),e}this.parser.setCallbackOnLoad(t),null!=a&&a instanceof Function||(a=function(e){let t=e;e.currentTarget&&null!==e.currentTarget.statusText&&(t="Error occurred while downloading!\nurl: "+e.currentTarget.responseURL+"\nstatus: "+e.currentTarget.statusText),n.parser.callbacks.onError(t)}),e||a("An invalid url was provided. Unable to continue!");let i=new URL(e,window.location.href).href,o=i,l=i.split("/");if(l.length>2){o=l[l.length-1];let e=l.slice(0,l.length-1).join("/")+"/";null!=e&&(this.path=e)}if(null==r||!(r instanceof Function)){let t=0,a=0;r=function(r){if(r.lengthComputable&&(a=r.loaded/r.total,a>t)){t=a;let r='Download of "'+e+'": '+(100*a).toFixed(2)+"%";n.parser.callbacks.onProgress("progressLoad",r,a)}}}this.setCallbackOnMeshAlter(s);let c=new FileLoader(this.manager);c.setPath(this.path||this.resourcePath),c.setResponseType("arraybuffer"),c.load(o,(function(e){n.parser.callbacks.onLoad(n.parse(e),"OBJLoader2#load: Parsing completed")}),r,a)},parse:function(e){if(null==e)throw"Provided content is not a valid ArrayBuffer or String. Unable to continue parsing";return this.parser.logging.enabled&&console.time("OBJLoader parse: "+this.modelName),this.materialHandler.createDefaultMaterials(!1),this.parser.setMaterials(this.materialHandler.getMaterials()),e instanceof ArrayBuffer||e instanceof Uint8Array?(this.parser.logging.enabled&&console.info("Parsing arrayBuffer..."),this.parser.execute(e)):"string"==typeof e||e instanceof String?(this.parser.logging.enabled&&console.info("Parsing text..."),this.parser.executeLegacy(e)):this.parser.callbacks.onError("Provided content was neither of type String nor Uint8Array! Aborting..."),this.parser.logging.enabled&&console.timeEnd("OBJLoader parse: "+this.modelName),this.baseObject3d},_onAssetAvailable:function(e){if("assetAvailable"===e.cmd)if("mesh"===e.type){let t=this.meshReceiver.buildMeshes(e);for(let e of t)this.baseObject3d.add(e)}else"material"===e.type&&this.materialHandler.addPayloadMaterials(e)}});export{OBJLoader2};