const CodeBuilderInstructions=function(e,r,t){this.supportsStandardWorker=e,this.supportsJsmWorker=r,this.preferJsmWorker=t,this.startCode="",this.codeFragments=[],this.importStatements=[],this.jsmWorkerFile=null,this.defaultGeometryType=0};CodeBuilderInstructions.prototype={constructor:CodeBuilderInstructions,isSupportsStandardWorker:function(){return this.supportsStandardWorker},isSupportsJsmWorker:function(){return this.supportsJsmWorker},isPreferJsmWorker:function(){return this.preferJsmWorker},setJsmWorkerFile:function(e){null!=e&&(this.jsmWorkerFile=e)},addStartCode:function(e){this.startCode=e},addCodeFragment:function(e){this.codeFragments.push(e)},addLibraryImport:function(e){let r='importScripts( "'+new URL(e,window.location.href).href+'" );';this.importStatements.push(r)},getImportStatements:function(){return this.importStatements},getCodeFragments:function(){return this.codeFragments},getStartCode:function(){return this.startCode}};const WorkerExecutionSupport=function(){if(void 0===window.Worker)throw"This browser does not support web workers!";if(void 0===window.Blob)throw"This browser does not support Blob!";if("function"!=typeof window.URL.createObjectURL)throw"This browser does not support Object creation from URL!";this._reset()};WorkerExecutionSupport.WORKER_SUPPORT_VERSION="3.1.0",console.info("Using WorkerSupport version: "+WorkerExecutionSupport.WORKER_SUPPORT_VERSION),WorkerExecutionSupport.prototype={constructor:WorkerExecutionSupport,_reset:function(){this.logging={enabled:!1,debug:!1};let e=this;this.worker={native:null,jsmWorker:!1,logging:!0,workerRunner:{name:"WorkerRunner",usesMeshDisassembler:!1,defaultGeometryType:0},terminateWorkerOnLoad:!0,forceWorkerDataCopy:!1,started:!1,queuedMessage:null,callbacks:{onAssetAvailable:null,onLoad:null,terminate:function(){e._terminate()}}}},setLogging:function(e,r){return this.logging.enabled=!0===e,this.logging.debug=!0===r,this.worker.logging=!0===e,this},setForceWorkerDataCopy:function(e){return this.worker.forceWorkerDataCopy=!0===e,this},setTerminateWorkerOnLoad:function(e){return this.worker.terminateWorkerOnLoad=!0===e,this.worker.terminateWorkerOnLoad&&this.isWorkerLoaded(this.worker.jsmWorker)&&null===this.worker.queuedMessage&&this.worker.started&&(this.logging.enabled&&console.info("Worker is terminated immediately as it is not running!"),this._terminate()),this},updateCallbacks:function(e,r){null!=e&&(this.worker.callbacks.onAssetAvailable=e),null!=r&&(this.worker.callbacks.onLoad=r),this._verifyCallbacks()},_verifyCallbacks:function(){if(void 0===this.worker.callbacks.onAssetAvailable||null===this.worker.callbacks.onAssetAvailable)throw'Unable to run as no "onAssetAvailable" callback is set.'},buildWorker:function(e){let r=!1;e.isSupportsJsmWorker()&&e.isPreferJsmWorker()&&(r=this._buildWorkerJsm(e)),!r&&e.isSupportsStandardWorker()&&this._buildWorkerStandard(e)},_buildWorkerJsm:function(e){let r=!0,t="buildWorkerJsm";if(!this._buildWorkerCheckPreconditions(!0,t)){let o=new URL(e.jsmWorkerFile,window.location.href).href;try{let r=new Worker(o,{type:"module"});this._configureWorkerCommunication(r,!0,e.defaultGeometryType,t)}catch(e){r=!1,(e instanceof TypeError||e instanceof SyntaxError)&&console.error("Modules are not supported in workers.")}}return r},_buildWorkerStandard:function(e){let r="buildWorkerStandard";if(!this._buildWorkerCheckPreconditions(!1,r)){let t="";e.getImportStatements().forEach((function(e){t+=e+"\n"})),t+="\n",e.getCodeFragments().forEach((function(e){t+=e+"\n"})),t+="\n",t+=e.getStartCode();let o=new Blob([t],{type:"application/javascript"}),s=new Worker(window.URL.createObjectURL(o));this._configureWorkerCommunication(s,!1,e.defaultGeometryType,r)}},_buildWorkerCheckPreconditions:function(e,r){let t=!1;return this.isWorkerLoaded(e)?t=!0:this.logging.enabled&&(console.info("WorkerExecutionSupport: Building "+(e?"jsm":"standard")+" worker code..."),console.time(r)),t},_configureWorkerCommunication:function(e,r,t,o){this.worker.native=e,this.worker.jsmWorker=r;let s=this;this.worker.native.onmessage=function(e){s._receiveWorkerMessage(e)},null!=t&&(this.worker.workerRunner.defaultGeometryType=t),this.logging.enabled&&console.timeEnd(o)},isWorkerLoaded:function(e){return null!==this.worker.native&&(e&&this.worker.jsmWorker||!e&&!this.worker.jsmWorker)},_receiveWorkerMessage:function(e){let r=e.data,t=this.worker.workerRunner.name;switch(r.cmd){case"assetAvailable":this.worker.callbacks.onAssetAvailable(r);break;case"completeOverall":this.worker.queuedMessage=null,this.worker.started=!1,null!==this.worker.callbacks.onLoad&&this.worker.callbacks.onLoad(r.msg),this.worker.terminateWorkerOnLoad&&(this.worker.logging.enabled&&console.info("WorkerSupport ["+t+"]: Run is complete. Terminating application on request!"),this.worker.callbacks.terminate());break;case"error":console.error("WorkerSupport ["+t+"]: Reported error: "+r.msg),this.worker.queuedMessage=null,this.worker.started=!1,null!==this.worker.callbacks.onLoad&&this.worker.callbacks.onLoad(r.msg),this.worker.terminateWorkerOnLoad&&(this.worker.logging.enabled&&console.info("WorkerSupport ["+t+"]: Run reported error. Terminating application on request!"),this.worker.callbacks.terminate());break;default:console.error("WorkerSupport ["+t+"]: Received unknown command: "+r.cmd)}},executeParallel:function(e,r){e.cmd="parse",e.usesMeshDisassembler=this.worker.workerRunner.usesMeshDisassembler,e.defaultGeometryType=this.worker.workerRunner.defaultGeometryType,this._verifyWorkerIsAvailable(e,r)&&this._postMessage()},_verifyWorkerIsAvailable:function(e,r){this._verifyCallbacks();let t=!0;return null!==this.worker.queuedMessage?(console.warn("Already processing message. Rejecting new run instruction"),t=!1):(this.worker.queuedMessage={payload:e,transferables:null==r?[]:r},this.worker.started=!0),t},_postMessage:function(){if(null!==this.worker.queuedMessage)if(this.worker.queuedMessage.payload.data.input instanceof ArrayBuffer){let e=[];this.worker.forceWorkerDataCopy?e.push(this.worker.queuedMessage.payload.data.input.slice(0)):e.push(this.worker.queuedMessage.payload.data.input),this.worker.queuedMessage.transferables.length>0&&(e=e.concat(this.worker.queuedMessage.transferables)),this.worker.native.postMessage(this.worker.queuedMessage.payload,e)}else this.worker.native.postMessage(this.worker.queuedMessage.payload)},_terminate:function(){this.worker.native.terminate(),this._reset()}};export{CodeBuilderInstructions,WorkerExecutionSupport};