import{Object3D}from"../../../build/three.module.js";import{CodeBuilderInstructions,WorkerExecutionSupport}from"./obj2/worker/main/WorkerExecutionSupport.js";import{CodeSerializer}from"./obj2/utils/CodeSerializer.js";import{OBJLoader2}from"./OBJLoader2.js";import{OBJLoader2Parser}from"./obj2/worker/parallel/OBJLoader2Parser.js";import{ObjectManipulator}from"./obj2/utils/ObjectManipulator.js";import{WorkerRunner,DefaultWorkerPayloadHandler}from"./obj2/worker/parallel/WorkerRunner.js";const OBJLoader2Parallel=function(e){OBJLoader2.call(this,e),this.preferJsmWorker=!1,this.executeParallel=!0,this.workerExecutionSupport=new WorkerExecutionSupport};OBJLoader2Parallel.OBJLOADER2_PARALLEL_VERSION="3.1.0",console.info("Using OBJLoader2Parallel version: "+OBJLoader2Parallel.OBJLOADER2_PARALLEL_VERSION),OBJLoader2Parallel.prototype=Object.assign(Object.create(OBJLoader2.prototype),{constructor:OBJLoader2Parallel,setExecuteParallel:function(e){return this.executeParallel=!0===e,this},setPreferJsmWorker:function(e){return this.preferJsmWorker=!0===e,this},getWorkerExecutionSupport:function(){return this.workerExecutionSupport},buildWorkerCode:function(){let e=new CodeBuilderInstructions(!0,!0,this.preferJsmWorker);if(e.isSupportsJsmWorker()&&e.setJsmWorkerFile("../../src/loaders/worker/parallel/jsm/OBJLoader2Worker.js"),e.isSupportsStandardWorker()){let r=CodeSerializer.serializeClass("OBJLoader2Parser",OBJLoader2Parser),a=CodeSerializer.serializeObject("ObjectManipulator",ObjectManipulator),o=CodeSerializer.serializeClass("DefaultWorkerPayloadHandler",DefaultWorkerPayloadHandler),t=CodeSerializer.serializeClass("WorkerRunner",WorkerRunner);e.addCodeFragment(r),e.addCodeFragment(a),e.addCodeFragment(o),e.addCodeFragment(t),e.addStartCode("new WorkerRunner( new DefaultWorkerPayloadHandler( new OBJLoader2Parser() ) );")}return e},load:function(e,r,a,o,t){let l=this;OBJLoader2.prototype.load.call(this,e,(function(e,a){"OBJLoader2ParallelDummy"===e.name?l.parser.logging.enabled&&l.parser.logging.debug&&console.debug("Received dummy answer from OBJLoader2Parallel#parse"):r(e,a)}),a,o,t)},parse:function(e){if(this.executeParallel){if(this.parser.callbacks.onLoad===this.parser._onLoad)throw"No callback other than the default callback was provided! Aborting!";if(!this.workerExecutionSupport.isWorkerLoaded(this.preferJsmWorker)){this.workerExecutionSupport.buildWorker(this.buildWorkerCode());let e=this,r=function(r){e._onAssetAvailable(r)};this.workerExecutionSupport.updateCallbacks(r,(function(r){e.parser.callbacks.onLoad(e.baseObject3d,r)}))}this.materialHandler.createDefaultMaterials(!1),this.workerExecutionSupport.executeParallel({params:{modelName:this.modelName,instanceNo:this.instanceNo,useIndices:this.parser.useIndices,disregardNormals:this.parser.disregardNormals,materialPerSmoothingGroup:this.parser.materialPerSmoothingGroup,useOAsMesh:this.parser.useOAsMesh},materials:this.materialHandler.getMaterialsJSON(),data:{input:e,options:null},logging:{enabled:this.parser.logging.enabled,debug:this.parser.logging.debug}});let r=new Object3D;return r.name="OBJLoader2ParallelDummy",r}return OBJLoader2.prototype.parse.call(this,e)}});export{OBJLoader2Parallel};