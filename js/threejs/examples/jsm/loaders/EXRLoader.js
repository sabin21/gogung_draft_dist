import{DataTextureLoader,FloatType,HalfFloatType,RGBAFormat,RGBFormat}from"../../../build/three.module.js";var EXRLoader=function(r){DataTextureLoader.call(this,r),this.type=FloatType};EXRLoader.prototype=Object.assign(Object.create(DataTextureLoader.prototype),{constructor:EXRLoader,setDataType:function(r){return this.type=r,this},parse:function(r){const e=65536,a=14,n=65537,t={l:0,c:0,lc:0};function i(r,e,a,n,i){for(;a<r;)e=e<<8|R(n,i),a+=8;a-=r,t.l=e>>a&(1<<r)-1,t.c=e,t.lc=a}const o=new Array(59);function l(r){return 63&r}function u(r){return r>>6}const f={c:0,lc:0};function c(r,e,a,n){r=r<<8|R(a,n),e+=8,f.c=r,f.lc=e}const v={c:0,lc:0};function s(r,e,a,n,t,i,o,l,u,s){if(r==e){n<8&&(c(a,n,t,o),a=f.c,n=f.lc);var p=a>>(n-=8);if(p=new Uint8Array([p])[0],u.value+p>s)return!1;for(var h=l[u.value-1];p-- >0;)l[u.value++]=h}else{if(!(u.value<s))return!1;l[u.value++]=r}v.c=a,v.lc=n}function p(r){var e=function(r){return 65535&r}(r);return e>32767?e-65536:e}const h={a:0,b:0};function y(r,e){var a=p(r),n=p(e),t=a+(1&n)+(n>>1),i=t,o=t-n;h.a=i,h.b=o}function w(r,e,a,n,t,i){for(var o,l=a>t?t:a,u=1;u<=l;)u<<=1;for(o=u>>=1,u>>=1;u>=1;){for(var f,c,v,s,p=0,w=p+i*(t-o),d=i*u,S=i*o,O=n*u,g=n*o;p<=w;p+=S){for(var E=p,R=p+n*(a-o);E<=R;E+=g){var x=E+O,T=(I=E+d)+O;y(e[E+r],e[I+r]),f=h.a,v=h.b,y(e[x+r],e[T+r]),c=h.a,s=h.b,y(f,c),e[E+r]=h.a,e[x+r]=h.b,y(v,s),e[I+r]=h.a,e[T+r]=h.b}if(a&u){var I=E+d;y(e[E+r],e[I+r]),f=h.a,e[I+r]=h.b,e[E+r]=f}}if(t&u)for(E=p,R=p+n*(a-o);E<=R;E+=g)x=E+O,y(e[E+r],e[x+r]),f=h.a,e[x+r]=h.b,e[E+r]=f;o=u,u>>=1}return p}function d(r,e,p,h,y,w,d){var S=p.value,O=E(e,p),g=E(e,p);p.value+=4;var R=E(e,p);if(p.value+=4,O<0||O>=n||g<0||g>=n)throw"Something wrong with HUF_ENCSIZE";var x=new Array(n),T=new Array(16384);if(function(r){for(var e=0;e<16384;e++)r[e]={},r[e].len=0,r[e].lit=0,r[e].p=null}(T),function(r,e,a,l,u,f,c){for(var v=a,s=0,p=0;u<=f;u++){if(v.value-a.value>l)return!1;i(6,s,p,r,v);var h=t.l;if(s=t.c,p=t.lc,c[u]=h,63==h){if(v.value-a.value>l)throw"Something wrong with hufUnpackEncTable";i(8,s,p,r,v);var y=t.l+6;if(s=t.c,p=t.lc,u+y>f+1)throw"Something wrong with hufUnpackEncTable";for(;y--;)c[u++]=0;u--}else if(h>=59){if(u+(y=h-59+2)>f+1)throw"Something wrong with hufUnpackEncTable";for(;y--;)c[u++]=0;u--}}!function(r){for(var e=0;e<=58;++e)o[e]=0;for(e=0;e<n;++e)o[r[e]]+=1;var a=0;for(e=58;e>0;--e){var t=a+o[e]>>1;o[e]=a,a=t}for(e=0;e<n;++e){var i=r[e];i>0&&(r[e]=i|o[i]++<<6)}}(c)}(r,0,p,h-(p.value-S),O,g,x),R>8*(h-(p.value-S)))throw"Something wrong with hufUncompress";!function(r,e,n,t){for(;e<=n;e++){var i=u(r[e]),o=l(r[e]);if(i>>o)throw"Invalid table entry";if(o>a){if((s=t[i>>o-a]).len)throw"Invalid table entry";if(s.lit++,s.p){var f=s.p;s.p=new Array(s.lit);for(var c=0;c<s.lit-1;++c)s.p[c]=f[c]}else s.p=new Array(1);s.p[s.lit-1]=e}else if(o){var v=0;for(c=1<<a-o;c>0;c--){var s;if((s=t[(i<<a-o)+v]).len||s.p)throw"Invalid table entry";s.len=o,s.lit=e,v++}}}}(x,O,g,T),function(r,e,n,t,i,o,p,h,y,w){for(var d=0,S=0,O=h,g=Math.trunc(i.value+(o+7)/8);i.value<g;)for(c(d,S,n,i),d=f.c,S=f.lc;S>=a;)if((T=e[d>>S-a&16383]).len)S-=T.len,s(T.lit,p,d,S,n,0,i,y,w,O),d=v.c,S=v.lc;else{if(!T.p)throw"hufDecode issues";var E;for(E=0;E<T.lit;E++){for(var R=l(r[T.p[E]]);S<R&&i.value<g;)c(d,S,n,i),d=f.c,S=f.lc;if(S>=R&&u(r[T.p[E]])==(d>>S-R&(1<<R)-1)){S-=R,s(T.p[E],p,d,S,n,0,i,y,w,O),d=v.c,S=v.lc;break}}if(E==T.lit)throw"hufDecode issues"}var x=8-o&7;for(d>>=x,S-=x;S>0;){var T;if(!(T=e[d<<a-S&16383]).len)throw"hufDecode issues";S-=T.len,s(T.lit,p,d,S,n,0,i,y,w,O),d=v.c,S=v.lc}}(x,T,r,0,p,R,g,d,y,w)}function S(r,a,n,t,i,o,l,u,f,c){var v=new Uint8Array(8192),s=m(t,i),p=m(t,i);if(p>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(s<=p)for(var h=0;h<p-s+1;h++)v[h+s]=x(t,i);var y=new Uint16Array(e);!function(r,a){for(var n=0,t=0;t<e;++t)(0==t||r[t>>3]&1<<(7&t))&&(a[n++]=t);for(;n<e;)a[n++]=0}(v,y),d(n,t,i,E(t,i),r,a,o);var S=new Array(l),O=0;for(h=0;h<l;h++)S[h]={},S[h].start=O,S[h].end=S[h].start,S[h].nx=f,S[h].ny=c,S[h].size=1,O+=S[h].nx*S[h].ny*S[h].size;var g=0;for(h=0;h<l;h++)for(var R=0;R<S[h].size;++R)g+=w(R+g,r,S[h].nx,S[h].size,S[h].ny,S[h].nx*S[h].size);return function(r,e,a){for(var n=0;n<a;++n)e[n]=r[e[n]]}(y,r,O),!0}function O(r,e){for(var a=new Uint8Array(r),n=0;0!=a[e.value+n];)n+=1;var t=(new TextDecoder).decode(a.slice(e.value,e.value+n));return e.value=e.value+n+1,t}function g(r,e){var a=r.getUint32(0,!0);return e.value=e.value+8,a}function E(r,e){var a=r.getUint32(e.value,!0);return e.value=e.value+4,a}function R(r,e){var a=r[e.value];return e.value=e.value+1,a}function x(r,e){var a=r.getUint8(e.value);return e.value=e.value+1,a}function T(r,e){var a=r.getFloat32(e.value,!0);return e.value+=4,a}function I(r){var e=(31744&r)>>10,a=1023&r;return(r>>15?-1:1)*(e?31===e?a?NaN:1/0:Math.pow(2,e-15)*(1+a/1024):a/1024*6103515625e-14)}function m(r,e){var a=r.getUint16(e.value,!0);return e.value+=2,a}function A(r,e){return I(m(r,e))}function M(r,e,a,n,t){if("string"===n||"iccProfile"===n)return function(r,e,a){var n=(new TextDecoder).decode(new Uint8Array(r).slice(e.value,e.value+a));return e.value=e.value+a,n}(e,a,t);if("chlist"===n)return function(r,e,a,n){for(var t=a.value,i=[];a.value<t+n-1;){var o=O(e,a),l=E(r,a),u=x(r,a);a.value+=3;var f=E(r,a),c=E(r,a);i.push({name:o,pixelType:l,pLinear:u,xSampling:f,ySampling:c})}return a.value+=1,i}(r,e,a,t);if("chromaticities"===n)return function(r,e){return{redX:T(r,e),redY:T(r,e),greenX:T(r,e),greenY:T(r,e),blueX:T(r,e),blueY:T(r,e),whiteX:T(r,e),whiteY:T(r,e)}}(r,a);if("compression"===n)return function(r,e){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][x(r,e)]}(r,a);if("box2i"===n)return function(r,e){return{xMin:E(r,e),yMin:E(r,e),xMax:E(r,e),yMax:E(r,e)}}(r,a);if("lineOrder"===n)return function(r,e){return["INCREASING_Y"][x(r,e)]}(r,a);if("float"===n)return T(r,a);if("v2f"===n)return function(r,e){return[T(r,e),T(r,e)]}(r,a);if("int"===n)return E(r,a);throw"Cannot parse value for unsupported type: "+n}var b=new DataView(r),P=new Uint8Array(r),N={};b.getUint32(0,!0),b.getUint8(4,!0),b.getUint8(5,!0);for(var U={value:8},_=!0;_;){var F=O(r,U);if(0==F)_=!1;else{var C=M(b,r,U,O(r,U),E(b,U));N[F]=C}}var L=N.dataWindow.yMax+1,X=1;"PIZ_COMPRESSION"===N.compression&&(X=32);for(var D=L/X,B=0;B<D;B++)g(b,U);var k=N.dataWindow.xMax-N.dataWindow.xMin+1,H=N.dataWindow.yMax-N.dataWindow.yMin+1,Z=N.channels.length;switch(this.type){case FloatType:var W=new Float32Array(k*H*Z);break;case HalfFloatType:W=new Uint16Array(k*H*Z);break;default:console.error("THREE.EXRLoader: unsupported type: ",this.type)}var G={R:0,G:1,B:2,A:3};if("NO_COMPRESSION"===N.compression)for(var z=0;z<H;z++){var Y=E(b,U);E(b,U);for(var j=0;j<N.channels.length;j++){var V=G[N.channels[j].name];if(1!==N.channels[j].pixelType)throw"EXRLoader._parser: unsupported pixelType "+N.channels[j].pixelType+". Only pixelType is 1 (HALF) is supported.";for(var q=0;q<k;q++){switch(this.type){case FloatType:var J=A(b,U);break;case HalfFloatType:J=m(b,U)}W[k*Z*(H-Y)+q*Z+V]=J}}}else{if("PIZ_COMPRESSION"!==N.compression)throw"EXRLoader._parser: "+N.compression+" is unsupported";for(var K=0;K<H/X;K++){E(b,U),E(b,U);var Q=k*X*(2*N.channels.length),$=new Uint16Array(Q);S($,{value:0},P,b,U,Q,Z,N.channels,k,X);for(var rr=0;rr<X;rr++)for(j=0;j<N.channels.length;j++){if(V=G[N.channels[j].name],1!==N.channels[j].pixelType)throw"EXRLoader._parser: unsupported pixelType "+N.channels[j].pixelType+". Only pixelType is 1 (HALF) is supported.";for(q=0;q<k;q++){var er=j*(X*k)+rr*k+q;switch(this.type){case FloatType:J=I($[er]);break;case HalfFloatType:J=$[er]}W[k*Z*(H-(rr+K*X))+q*Z+V]=J}}}}return{header:N,width:k,height:H,data:W,format:4==N.channels.length?RGBAFormat:RGBFormat,type:this.type}}});export{EXRLoader};