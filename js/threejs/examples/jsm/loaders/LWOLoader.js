import{AddOperation,BackSide,BufferAttribute,BufferGeometry,ClampToEdgeWrapping,Color,DoubleSide,EquirectangularReflectionMapping,EquirectangularRefractionMapping,FileLoader,Float32BufferAttribute,FrontSide,LineBasicMaterial,LineSegments,Loader,LoaderUtils,Mesh,MeshPhongMaterial,MeshPhysicalMaterial,MeshStandardMaterial,MirroredRepeatWrapping,Points,PointsMaterial,RepeatWrapping,TextureLoader,Vector2}from"../../../build/three.module.js";function LWO2Parser(e){this.IFF=e}function LWO3Parser(e){this.IFF=e}function IFFParser(){this.debugger=new Debugger}function DataViewReader(e){this.dv=new DataView(e),this.offset=0}function Debugger(){this.active=!1,this.depth=0,this.formList=[]}function isEven(e){return e%2}function stringOffset(e){return e.length+1+(isEven(e.length+1)?1:0)}function printBuffer(e,r,t){console.log(LoaderUtils.decodeText(new Uint8Array(e,r,t)))}var lwoTree;LWO2Parser.prototype={constructor:LWO2Parser,parseBlock:function(){this.IFF.debugger.offset=this.IFF.reader.offset,this.IFF.debugger.closeForms();var e=this.IFF.reader.getIDTag(),r=this.IFF.reader.getUint32();switch(r>this.IFF.reader.dv.byteLength-this.IFF.reader.offset&&(this.IFF.reader.offset-=4,r=this.IFF.reader.getUint16()),this.IFF.debugger.dataOffset=this.IFF.reader.offset,this.IFF.debugger.length=r,e){case"FORM":this.IFF.parseForm(r);break;case"ICON":case"VMPA":case"BBOX":case"NORM":case"PRE ":case"POST":case"KEY ":case"SPAN":case"TIME":case"CLRS":case"CLRA":case"FILT":case"DITH":case"CONT":case"BRIT":case"SATR":case"HUE ":case"GAMM":case"NEGA":case"IFLT":case"PFLT":case"PROJ":case"AXIS":case"AAST":case"PIXB":case"AUVO":case"STCK":case"PROC":case"VALU":case"FUNC":case"PNAM":case"INAM":case"GRST":case"GREN":case"GRPT":case"FKEY":case"IKEY":case"CSYS":case"OPAQ":case"CMAP":case"NLOC":case"NZOM":case"NVER":case"NSRV":case"NVSK":case"NCRD":case"WRPW":case"WRPH":case"NMOD":case"NPRW":case"NPLA":case"NODS":case"VERS":case"ENUM":case"TAG ":case"OPAC":case"CGMD":case"CGTY":case"CGST":case"CGEN":case"CGTS":case"CGTE":case"OSMP":case"OMDE":case"OUTR":case"FLAG":case"TRNL":case"GLOW":case"GVAL":case"SHRP":case"RFOP":case"RSAN":case"TROP":case"RBLR":case"TBLR":case"CLRH":case"CLRF":case"ADTR":case"LINE":case"ALPH":case"VCOL":case"ENAB":case"TMAP":this.IFF.debugger.skipped=!0,this.IFF.reader.skip(r);break;case"SURF":this.IFF.parseSurfaceLwo2(r);break;case"CLIP":this.IFF.parseClipLwo2(r);break;case"IPIX":case"IMIP":case"IMOD":case"AMOD":case"IINV":case"INCR":case"IAXS":case"IFOT":case"ITIM":case"IWRL":case"IUTI":case"IINX":case"IINY":case"IINZ":case"IREF":4===r?this.IFF.currentNode[e]=this.IFF.reader.getInt32():this.IFF.reader.skip(r);break;case"OTAG":this.IFF.parseObjectTag();break;case"LAYR":this.IFF.parseLayer(r);break;case"PNTS":this.IFF.parsePoints(r);break;case"VMAP":this.IFF.parseVertexMapping(r);break;case"AUVU":case"AUVN":this.IFF.reader.skip(r-1),this.IFF.reader.getVariableLengthIndex();break;case"POLS":this.IFF.parsePolygonList(r);break;case"TAGS":this.IFF.parseTagStrings(r);break;case"PTAG":this.IFF.parsePolygonTagMapping(r);break;case"VMAD":this.IFF.parseVertexMapping(r,!0);break;case"DESC":this.IFF.currentForm.description=this.IFF.reader.getString();break;case"TEXT":case"CMNT":case"NCOM":this.IFF.currentForm.comment=this.IFF.reader.getString();break;case"NAME":this.IFF.currentForm.channelName=this.IFF.reader.getString();break;case"WRAP":this.IFF.currentForm.wrap={w:this.IFF.reader.getUint16(),h:this.IFF.reader.getUint16()};break;case"IMAG":var t=this.IFF.reader.getVariableLengthIndex();this.IFF.currentForm.imageIndex=t;break;case"OREF":this.IFF.currentForm.referenceObject=this.IFF.reader.getString();break;case"ROID":this.IFF.currentForm.referenceObjectID=this.IFF.reader.getUint32();break;case"SSHN":this.IFF.currentSurface.surfaceShaderName=this.IFF.reader.getString();break;case"AOVN":this.IFF.currentSurface.surfaceCustomAOVName=this.IFF.reader.getString();break;case"NSTA":this.IFF.currentForm.disabled=this.IFF.reader.getUint16();break;case"NRNM":this.IFF.currentForm.realName=this.IFF.reader.getString();break;case"NNME":this.IFF.currentForm.refName=this.IFF.reader.getString(),this.IFF.currentSurface.nodes[this.IFF.currentForm.refName]=this.IFF.currentForm;break;case"INME":this.IFF.currentForm.nodeName||(this.IFF.currentForm.nodeName=[]),this.IFF.currentForm.nodeName.push(this.IFF.reader.getString());break;case"IINN":this.IFF.currentForm.inputNodeName||(this.IFF.currentForm.inputNodeName=[]),this.IFF.currentForm.inputNodeName.push(this.IFF.reader.getString());break;case"IINM":this.IFF.currentForm.inputName||(this.IFF.currentForm.inputName=[]),this.IFF.currentForm.inputName.push(this.IFF.reader.getString());break;case"IONM":this.IFF.currentForm.inputOutputName||(this.IFF.currentForm.inputOutputName=[]),this.IFF.currentForm.inputOutputName.push(this.IFF.reader.getString());break;case"FNAM":this.IFF.currentForm.fileName=this.IFF.reader.getString();break;case"CHAN":4===r?this.IFF.currentForm.textureChannel=this.IFF.reader.getIDTag():this.IFF.reader.skip(r);break;case"SMAN":var a=this.IFF.reader.getFloat32();this.IFF.currentSurface.attributes.smooth=!(a<0);break;case"COLR":this.IFF.currentSurface.attributes.Color={value:this.IFF.reader.getFloat32Array(3)},this.IFF.reader.skip(2);break;case"LUMI":this.IFF.currentSurface.attributes.Luminosity={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"SPEC":this.IFF.currentSurface.attributes.Specular={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"DIFF":this.IFF.currentSurface.attributes.Diffuse={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"REFL":this.IFF.currentSurface.attributes.Reflection={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"GLOS":this.IFF.currentSurface.attributes.Glossiness={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"TRAN":this.IFF.currentSurface.attributes.opacity=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"BUMP":this.IFF.currentSurface.attributes.bumpStrength=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"SIDE":this.IFF.currentSurface.attributes.side=this.IFF.reader.getUint16();break;case"RIMG":this.IFF.currentSurface.attributes.reflectionMap=this.IFF.reader.getVariableLengthIndex();break;case"RIND":this.IFF.currentSurface.attributes.refractiveIndex=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"TIMG":this.IFF.currentSurface.attributes.refractionMap=this.IFF.reader.getVariableLengthIndex();break;case"IMAP":this.IFF.reader.skip(2);break;case"IUVI":this.IFF.currentNode.UVChannel=this.IFF.reader.getString(r);break;case"IUTL":this.IFF.currentNode.widthWrappingMode=this.IFF.reader.getUint32();break;case"IVTL":this.IFF.currentNode.heightWrappingMode=this.IFF.reader.getUint32();break;case"BLOK":break;default:this.IFF.parseUnknownCHUNK(e,r)}"FORM"!=e&&(this.IFF.debugger.node=1,this.IFF.debugger.nodeID=e,this.IFF.debugger.log()),this.IFF.reader.offset>=this.IFF.currentFormEnd&&(this.IFF.currentForm=this.IFF.parentForm)}},LWO3Parser.prototype={constructor:LWO3Parser,parseBlock:function(){this.IFF.debugger.offset=this.IFF.reader.offset,this.IFF.debugger.closeForms();var e=this.IFF.reader.getIDTag(),r=this.IFF.reader.getUint32();switch(this.IFF.debugger.dataOffset=this.IFF.reader.offset,this.IFF.debugger.length=r,e){case"FORM":this.IFF.parseForm(r);break;case"ICON":case"VMPA":case"BBOX":case"NORM":case"PRE ":case"POST":case"KEY ":case"SPAN":case"TIME":case"CLRS":case"CLRA":case"FILT":case"DITH":case"CONT":case"BRIT":case"SATR":case"HUE ":case"GAMM":case"NEGA":case"IFLT":case"PFLT":case"PROJ":case"AXIS":case"AAST":case"PIXB":case"STCK":case"VALU":case"PNAM":case"INAM":case"GRST":case"GREN":case"GRPT":case"FKEY":case"IKEY":case"CSYS":case"OPAQ":case"CMAP":case"NLOC":case"NZOM":case"NVER":case"NSRV":case"NCRD":case"NMOD":case"NSEL":case"NPRW":case"NPLA":case"VERS":case"ENUM":case"TAG ":case"CGMD":case"CGTY":case"CGST":case"CGEN":case"CGTS":case"CGTE":case"OSMP":case"OMDE":case"OUTR":case"FLAG":case"TRNL":case"SHRP":case"RFOP":case"RSAN":case"TROP":case"RBLR":case"TBLR":case"CLRH":case"CLRF":case"ADTR":case"GLOW":case"LINE":case"ALPH":case"VCOL":case"ENAB":this.IFF.debugger.skipped=!0,this.IFF.reader.skip(r);break;case"IPIX":case"IMIP":case"IMOD":case"AMOD":case"IINV":case"INCR":case"IAXS":case"IFOT":case"ITIM":case"IWRL":case"IUTI":case"IINX":case"IINY":case"IINZ":case"IREF":4===r?this.IFF.currentNode[e]=this.IFF.reader.getInt32():this.IFF.reader.skip(r);break;case"OTAG":this.IFF.parseObjectTag();break;case"LAYR":this.IFF.parseLayer(r);break;case"PNTS":this.IFF.parsePoints(r);break;case"VMAP":this.IFF.parseVertexMapping(r);break;case"POLS":this.IFF.parsePolygonList(r);break;case"TAGS":this.IFF.parseTagStrings(r);break;case"PTAG":this.IFF.parsePolygonTagMapping(r);break;case"VMAD":this.IFF.parseVertexMapping(r,!0);break;case"DESC":this.IFF.currentForm.description=this.IFF.reader.getString();break;case"TEXT":case"CMNT":case"NCOM":this.IFF.currentForm.comment=this.IFF.reader.getString();break;case"NAME":this.IFF.currentForm.channelName=this.IFF.reader.getString();break;case"WRAP":this.IFF.currentForm.wrap={w:this.IFF.reader.getUint16(),h:this.IFF.reader.getUint16()};break;case"IMAG":var t=this.IFF.reader.getVariableLengthIndex();this.IFF.currentForm.imageIndex=t;break;case"OREF":this.IFF.currentForm.referenceObject=this.IFF.reader.getString();break;case"ROID":this.IFF.currentForm.referenceObjectID=this.IFF.reader.getUint32();break;case"SSHN":this.IFF.currentSurface.surfaceShaderName=this.IFF.reader.getString();break;case"AOVN":this.IFF.currentSurface.surfaceCustomAOVName=this.IFF.reader.getString();break;case"NSTA":this.IFF.currentForm.disabled=this.IFF.reader.getUint16();break;case"NRNM":this.IFF.currentForm.realName=this.IFF.reader.getString();break;case"NNME":this.IFF.currentForm.refName=this.IFF.reader.getString(),this.IFF.currentSurface.nodes[this.IFF.currentForm.refName]=this.IFF.currentForm;break;case"INME":this.IFF.currentForm.nodeName||(this.IFF.currentForm.nodeName=[]),this.IFF.currentForm.nodeName.push(this.IFF.reader.getString());break;case"IINN":this.IFF.currentForm.inputNodeName||(this.IFF.currentForm.inputNodeName=[]),this.IFF.currentForm.inputNodeName.push(this.IFF.reader.getString());break;case"IINM":this.IFF.currentForm.inputName||(this.IFF.currentForm.inputName=[]),this.IFF.currentForm.inputName.push(this.IFF.reader.getString());break;case"IONM":this.IFF.currentForm.inputOutputName||(this.IFF.currentForm.inputOutputName=[]),this.IFF.currentForm.inputOutputName.push(this.IFF.reader.getString());break;case"FNAM":this.IFF.currentForm.fileName=this.IFF.reader.getString();break;case"CHAN":4===r?this.IFF.currentForm.textureChannel=this.IFF.reader.getIDTag():this.IFF.reader.skip(r);break;case"SMAN":var a=this.IFF.reader.getFloat32();this.IFF.currentSurface.attributes.smooth=!(a<0);break;case"COLR":this.IFF.currentSurface.attributes.Color={value:this.IFF.reader.getFloat32Array(3)},this.IFF.reader.skip(2);break;case"LUMI":this.IFF.currentSurface.attributes.Luminosity={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"SPEC":this.IFF.currentSurface.attributes.Specular={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"DIFF":this.IFF.currentSurface.attributes.Diffuse={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"REFL":this.IFF.currentSurface.attributes.Reflection={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"GLOS":this.IFF.currentSurface.attributes.Glossiness={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"TRAN":this.IFF.currentSurface.attributes.opacity=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"BUMP":this.IFF.currentSurface.attributes.bumpStrength=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"SIDE":this.IFF.currentSurface.attributes.side=this.IFF.reader.getUint16();break;case"RIMG":this.IFF.currentSurface.attributes.reflectionMap=this.IFF.reader.getVariableLengthIndex();break;case"RIND":this.IFF.currentSurface.attributes.refractiveIndex=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"TIMG":this.IFF.currentSurface.attributes.refractionMap=this.IFF.reader.getVariableLengthIndex();break;case"IMAP":this.IFF.currentSurface.attributes.imageMapIndex=this.IFF.reader.getUint32();break;case"IUVI":this.IFF.currentNode.UVChannel=this.IFF.reader.getString(r);break;case"IUTL":this.IFF.currentNode.widthWrappingMode=this.IFF.reader.getUint32();break;case"IVTL":this.IFF.currentNode.heightWrappingMode=this.IFF.reader.getUint32();break;default:this.IFF.parseUnknownCHUNK(e,r)}"FORM"!=e&&(this.IFF.debugger.node=1,this.IFF.debugger.nodeID=e,this.IFF.debugger.log()),this.IFF.reader.offset>=this.IFF.currentFormEnd&&(this.IFF.currentForm=this.IFF.parentForm)}},IFFParser.prototype={constructor:IFFParser,parse:function(e){if(this.reader=new DataViewReader(e),this.tree={materials:{},layers:[],tags:[],textures:[]},this.currentLayer=this.tree,this.currentForm=this.tree,this.parseTopForm(),void 0!==this.tree.format){if("LWO2"===this.tree.format)for(this.parser=new LWO2Parser(this);!this.reader.endOfFile();)this.parser.parseBlock();else if("LWO3"===this.tree.format)for(this.parser=new LWO3Parser(this);!this.reader.endOfFile();)this.parser.parseBlock();return this.debugger.offset=this.reader.offset,this.debugger.closeForms(),this.tree}},parseTopForm(){if(this.debugger.offset=this.reader.offset,"FORM"===this.reader.getIDTag()){var e=this.reader.getUint32();this.debugger.dataOffset=this.reader.offset,this.debugger.length=e;var r=this.reader.getIDTag();("LWO2"===r||"LWO3"===r)&&(this.tree.format=r),this.debugger.node=0,this.debugger.nodeID=r,this.debugger.log()}else console.warn("LWOLoader: Top-level FORM missing.")},parseForm(e){var r=this.reader.getIDTag();switch(r){case"ISEQ":case"ANIM":case"STCC":case"VPVL":case"VPRM":case"NROT":case"WRPW":case"WRPH":case"FUNC":case"FALL":case"OPAC":case"GRAD":case"ENVS":case"VMOP":case"VMBG":case"OMAX":case"STEX":case"CKBG":case"CKEY":case"VMLA":case"VMLB":this.debugger.skipped=!0,this.skipForm(e);break;case"META":case"NNDS":case"NODS":case"NDTA":case"ADAT":case"AOVS":case"BLOK":case"IBGC":case"IOPC":case"IIMG":case"TXTR":this.debugger.length=4,this.debugger.skipped=!0;break;case"IFAL":case"ISCL":case"IPOS":case"IROT":case"IBMP":case"IUTD":case"IVTD":this.parseTextureNodeAttribute(r);break;case"ENVL":this.parseEnvelope(e);break;case"CLIP":"LWO2"===this.tree.format?this.parseForm(e):this.parseClip(e);break;case"STIL":this.parseImage();break;case"XREF":this.reader.skip(8),this.currentForm.referenceTexture={index:this.reader.getUint32(),refName:this.reader.getString()};break;case"IMST":this.parseImageStateForm(e);break;case"SURF":this.parseSurfaceForm(e);break;case"VALU":this.parseValueForm(e);break;case"NTAG":this.parseSubNode(e);break;case"ATTR":case"SATR":this.setupForm("attributes",e);break;case"NCON":this.parseConnections(e);break;case"SSHA":this.parentForm=this.currentForm,this.currentForm=this.currentSurface,this.setupForm("surfaceShader",e);break;case"SSHD":this.setupForm("surfaceShaderData",e);break;case"ENTR":this.parseEntryForm(e);break;case"IMAP":this.parseImageMap(e);break;case"TAMP":this.parseXVAL("amplitude",e);break;case"TMAP":this.setupForm("textureMap",e);break;case"CNTR":this.parseXVAL3("center",e);break;case"SIZE":this.parseXVAL3("scale",e);break;case"ROTA":this.parseXVAL3("rotation",e);break;default:this.parseUnknownForm(r,e)}this.debugger.node=0,this.debugger.nodeID=r,this.debugger.log()},setupForm(e,r){this.currentForm||(this.currentForm=this.currentNode),this.currentFormEnd=this.reader.offset+r,this.parentForm=this.currentForm,this.currentForm[e]?(console.warn("LWOLoader: form already exists on parent: ",e,this.currentForm),this.currentForm=this.currentForm[e]):(this.currentForm[e]={},this.currentForm=this.currentForm[e])},skipForm(e){this.reader.skip(e-4)},parseUnknownForm(e,r){console.warn("LWOLoader: unknown FORM encountered: "+e,r),printBuffer(this.reader.dv.buffer,this.reader.offset,r-4),this.reader.skip(r-4)},parseSurfaceForm(e){this.reader.skip(8);var r=this.reader.getString(),t={attributes:{},connections:{},name:r,inputName:r,nodes:{},source:this.reader.getString()};this.tree.materials[r]=t,this.currentSurface=t,this.parentForm=this.tree.materials,this.currentForm=t,this.currentFormEnd=this.reader.offset+e},parseSurfaceLwo2(e){var r=this.reader.getString(),t={attributes:{},connections:{},name:r,nodes:{},source:this.reader.getString()};this.tree.materials[r]=t,this.currentSurface=t,this.parentForm=this.tree.materials,this.currentForm=t,this.currentFormEnd=this.reader.offset+e},parseSubNode(e){this.reader.skip(8);var r={name:this.reader.getString()};this.currentForm=r,this.currentNode=r,this.currentFormEnd=this.reader.offset+e},parseConnections(e){this.currentFormEnd=this.reader.offset+e,this.parentForm=this.currentForm,this.currentForm=this.currentSurface.connections},parseEntryForm(e){this.reader.skip(8);var r=this.reader.getString();this.currentForm=this.currentNode.attributes,this.setupForm(r,e)},parseValueForm(){this.reader.skip(8);var e=this.reader.getString();"double"===e?this.currentForm.value=this.reader.getUint64():"int"===e?this.currentForm.value=this.reader.getUint32():"vparam"===e?(this.reader.skip(24),this.currentForm.value=this.reader.getFloat64()):"vparam3"===e&&(this.reader.skip(24),this.currentForm.value=this.reader.getFloat64Array(3))},parseImageStateForm(){this.reader.skip(8),this.currentForm.mipMapLevel=this.reader.getFloat32()},parseImageMap(e){this.currentFormEnd=this.reader.offset+e,this.parentForm=this.currentForm,this.currentForm.maps||(this.currentForm.maps=[]);var r={};this.currentForm.maps.push(r),this.currentForm=r,this.reader.skip(10)},parseTextureNodeAttribute(e){switch(this.reader.skip(28),this.reader.skip(20),e){case"ISCL":this.currentNode.scale=this.reader.getFloat32Array(3);break;case"IPOS":this.currentNode.position=this.reader.getFloat32Array(3);break;case"IROT":this.currentNode.rotation=this.reader.getFloat32Array(3);break;case"IFAL":this.currentNode.falloff=this.reader.getFloat32Array(3);break;case"IBMP":this.currentNode.amplitude=this.reader.getFloat32();break;case"IUTD":this.currentNode.uTiles=this.reader.getFloat32();break;case"IVTD":this.currentNode.vTiles=this.reader.getFloat32()}this.reader.skip(2)},parseEnvelope(e){this.reader.skip(e-4)},parseClip(e){if("FORM"===this.reader.getIDTag())return this.reader.skip(16),void(this.currentNode.fileName=this.reader.getString());this.reader.setOffset(this.reader.offset-4),this.currentFormEnd=this.reader.offset+e,this.parentForm=this.currentForm,this.reader.skip(8);var r={index:this.reader.getUint32()};this.tree.textures.push(r),this.currentForm=r},parseClipLwo2(e){for(var r={index:this.reader.getUint32(),fileName:""};;){var t=this.reader.getIDTag(),a=this.reader.getUint16();if("STIL"===t){r.fileName=this.reader.getString();break}if(a>=e)break}this.tree.textures.push(r),this.currentForm=r},parseImage(){this.reader.skip(8),this.currentForm.fileName=this.reader.getString()},parseXVAL(e,r){var t=this.reader.offset+r-4;this.reader.skip(8),this.currentForm[e]=this.reader.getFloat32(),this.reader.setOffset(t)},parseXVAL3(e,r){var t=this.reader.offset+r-4;this.reader.skip(8),this.currentForm[e]={x:this.reader.getFloat32(),y:this.reader.getFloat32(),z:this.reader.getFloat32()},this.reader.setOffset(t)},parseObjectTag(){this.tree.objectTags||(this.tree.objectTags={}),this.tree.objectTags[this.reader.getIDTag()]={tagString:this.reader.getString()}},parseLayer(e){var r={number:this.reader.getUint16(),flags:this.reader.getUint16(),pivot:this.reader.getFloat32Array(3),name:this.reader.getString()};this.tree.layers.push(r),this.currentLayer=r;var t=16+stringOffset(this.currentLayer.name);this.currentLayer.parent=t<e?this.reader.getUint16():-1},parsePoints(e){this.currentPoints=[];for(var r=0;r<e/4;r+=3)this.currentPoints.push(this.reader.getFloat32(),this.reader.getFloat32(),-this.reader.getFloat32())},parseVertexMapping(e,r){var t=this.reader.offset+e,a=this.reader.getString();if(this.reader.offset!==t){this.reader.setOffset(this.reader.offset-stringOffset(a));var s=this.reader.getIDTag();this.reader.getUint16();var i=this.reader.getString(),n=e-6-stringOffset(i);switch(s){case"TXUV":this.parseUVMapping(i,t,r);break;case"MORF":case"SPOT":this.parseMorphTargets(i,t,s);break;case"APSL":case"NORM":case"WGHT":case"MNVW":case"PICK":case"RGB ":case"RGBA":this.reader.skip(n);break;default:console.warn("LWOLoader: unknown vertex map type: "+s),this.reader.skip(n)}}else this.currentForm.UVChannel=a},parseUVMapping(e,r,t){for(var a=[],s=[],i=[];this.reader.offset<r;)a.push(this.reader.getVariableLengthIndex()),t&&s.push(this.reader.getVariableLengthIndex()),i.push(this.reader.getFloat32(),this.reader.getFloat32());t?(this.currentLayer.discontinuousUVs||(this.currentLayer.discontinuousUVs={}),this.currentLayer.discontinuousUVs[e]={uvIndices:a,polyIndices:s,uvs:i}):(this.currentLayer.uvs||(this.currentLayer.uvs={}),this.currentLayer.uvs[e]={uvIndices:a,uvs:i})},parseMorphTargets(e,r,t){var a=[],s=[];for(t="MORF"===t?"relative":"absolute";this.reader.offset<r;)a.push(this.reader.getVariableLengthIndex()),s.push(this.reader.getFloat32(),this.reader.getFloat32(),-this.reader.getFloat32());this.currentLayer.morphTargets||(this.currentLayer.morphTargets={}),this.currentLayer.morphTargets[e]={indices:a,points:s,type:t}},parsePolygonList(e){for(var r=this.reader.offset+e,t=this.reader.getIDTag(),a=[],s=[];this.reader.offset<r;){var i=this.reader.getUint16();i&=1023,s.push(i);for(var n=0;n<i;n++)a.push(this.reader.getVariableLengthIndex())}var o={type:t,vertexIndices:a,polygonDimensions:s,points:this.currentPoints};1===s[0]?o.type="points":2===s[0]&&(o.type="lines"),this.currentLayer.geometry=o},parseTagStrings(e){this.tree.tags=this.reader.getStringArray(e)},parsePolygonTagMapping(e){var r=this.reader.offset+e;"SURF"===this.reader.getIDTag()?this.parseMaterialIndices(r):this.reader.skip(e-4)},parseMaterialIndices(e){for(this.currentLayer.geometry.materialIndices=[];this.reader.offset<e;){var r=this.reader.getVariableLengthIndex(),t=this.reader.getUint16();this.currentLayer.geometry.materialIndices.push(r,t)}},parseUnknownCHUNK(e,r){console.warn("LWOLoader: unknown chunk type: "+e+" length: "+r);var t=this.reader.getString(r);this.currentForm[e]=t}},DataViewReader.prototype={constructor:DataViewReader,size:function(){return this.dv.buffer.byteLength},setOffset(e){e>0&&e<this.dv.buffer.byteLength?this.offset=e:console.error("LWOLoader: invalid buffer offset")},endOfFile:function(){return this.offset>=this.size()},skip:function(e){this.offset+=e},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getUint16:function(){var e=this.dv.getUint16(this.offset);return this.offset+=2,e},getInt32:function(){var e=this.dv.getInt32(this.offset,!1);return this.offset+=4,e},getUint32:function(){var e=this.dv.getUint32(this.offset,!1);return this.offset+=4,e},getUint64:function(){return 4294967296*this.getUint32()+this.getUint32()},getFloat32:function(){var e=this.dv.getFloat32(this.offset,!1);return this.offset+=4,e},getFloat32Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getFloat32());return r},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getFloat64());return r},getVariableLengthIndex(){var e=this.getUint8();return 255===e?65536*this.getUint8()+256*this.getUint8()+this.getUint8():256*e+this.getUint8()},getIDTag(){return this.getString(4)},getString:function(e){if(0!==e){var r=[];if(e)for(var t=0;t<e;t++)r[t]=this.getUint8();else{for(var a,s=0;0!==a;)0!==(a=this.getUint8())&&r.push(a),s++;isEven(s+1)||this.getUint8()}return LoaderUtils.decodeText(new Uint8Array(r))}},getStringArray:function(e){var r=this.getString(e);return(r=r.split("\0")).filter(Boolean)}},Debugger.prototype={constructor:Debugger,enable:function(){this.active=!0},log:function(){if(this.active){var e;switch(this.node){case 0:e="FORM";break;case 1:e="CHK";break;case 2:e="S-CHK"}console.log("| ".repeat(this.depth)+e,this.nodeID,`( ${this.offset} ) -> ( ${this.dataOffset+this.length} )`,0==this.node?" {":"",this.skipped?"SKIPPED":"",0==this.node&&this.skipped?"}":""),0!=this.node||this.skipped||(this.depth+=1,this.formList.push(this.dataOffset+this.length)),this.skipped=!1}},closeForms:function(){if(this.active)for(var e=this.formList.length-1;e>=0;e--)this.offset>=this.formList[e]&&(this.depth-=1,console.log("| ".repeat(this.depth)+"}"),this.formList.splice(-1,1))}};var LWOLoader=function(e,r){Loader.call(this,e),r=r||{},this.resourcePath=void 0!==r.resourcePath?r.resourcePath:""};function LWOTreeParser(e){this.textureLoader=e}function MaterialParser(e){this.textureLoader=e}function GeometryParser(){}function extractParentUrl(e,r){var t=e.indexOf(r);return-1===t?"./":e.substr(0,t)}LWOLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:LWOLoader,load:function(e,r,t,a){var s=this,i=""===s.path?extractParentUrl(e,"Objects"):s.path,n=e.split(i).pop().split(".")[0],o=new FileLoader(this.manager);o.setPath(s.path),o.setResponseType("arraybuffer"),o.load(e,(function(e){r(s.parse(e,i,n))}),t,a)},parse:function(e,r,t){return lwoTree=(new IFFParser).parse(e),new LWOTreeParser(new TextureLoader(this.manager).setPath(this.resourcePath||r).setCrossOrigin(this.crossOrigin)).parse(t)}}),LWOTreeParser.prototype={constructor:LWOTreeParser,parse:function(e){return this.materials=new MaterialParser(this.textureLoader).parse(),this.defaultLayerName=e,this.meshes=this.parseLayers(),{materials:this.materials,meshes:this.meshes}},parseLayers(){var e=[],r=[],t=new GeometryParser,a=this;return lwoTree.layers.forEach((function(s){var i=t.parse(s.geometry,s),n=a.parseMesh(i,s);e[s.number]=n,-1===s.parent?r.push(n):e[s.parent].add(n)})),this.applyPivots(r),r},parseMesh(e,r){var t,a=this.getMaterials(e.userData.matNames,r.geometry.type);return this.duplicateUVs(e,a),t="points"===r.geometry.type?new Points(e,a):"lines"===r.geometry.type?new LineSegments(e,a):new Mesh(e,a),r.name?t.name=r.name:t.name=this.defaultLayerName+"_layer_"+r.number,t.userData.pivot=r.pivot,t},applyPivots(e){e.forEach((function(e){e.traverse((function(e){var r=e.userData.pivot;if(e.position.x+=r[0],e.position.y+=r[1],e.position.z+=r[2],e.parent){var t=e.parent.userData.pivot;e.position.x-=t[0],e.position.y-=t[1],e.position.z-=t[2]}}))}))},getMaterials(e,r){var t=[],a=this;e.forEach((function(e,r){t[r]=a.getMaterialByName(e)})),"points"!==r&&"lines"!==r||t.forEach((function(e,a){var s={color:e.color};"points"===r?(s.size=.1,s.map=e.map,s.morphTargets=e.morphTargets,t[a]=new PointsMaterial(s)):"lines"===r&&(t[a]=new LineBasicMaterial(s))}));var s=t.filter(Boolean);return 1===s.length?s[0]:t},getMaterialByName(e){return this.materials.filter((function(r){return r.name===e}))[0]},duplicateUVs(e,r){var t=!1;Array.isArray(r)?r.forEach((function(e){e.aoMap&&(t=!0)})):r.aoMap&&(t=!0),t&&e.addAttribute("uv2",new BufferAttribute(e.attributes.uv.array,2))}},MaterialParser.prototype={constructor:MaterialParser,parse:function(){var e=[];for(var r in this.textures={},lwoTree.materials)"LWO3"===lwoTree.format?e.push(this.parseMaterial(lwoTree.materials[r],r,lwoTree.textures)):"LWO2"===lwoTree.format&&e.push(this.parseMaterialLwo2(lwoTree.materials[r],r,lwoTree.textures));return e},parseMaterial(e,r,t){var a={name:r,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)},s=this.parseConnections(e.connections,e.nodes),i=this.parseTextureNodes(s.maps);this.parseAttributeImageMaps(s.attributes,t,i,e.maps);var n=this.parseAttributes(s.attributes,i);return this.parseEnvMap(s,i,n),a=Object.assign(i,a),a=Object.assign(a,n),new(this.getMaterialType(s.attributes))(a)},parseMaterialLwo2(e,r){var t={name:r,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)},a=this.parseAttributes(e.attributes,{});return t=Object.assign(t,a),new MeshPhongMaterial(t)},getSide(e){if(!e.side)return BackSide;switch(e.side){case 0:case 1:return BackSide;case 2:return FrontSide;case 3:return DoubleSide}},getSmooth:e=>!e.smooth||!e.smooth,parseConnections(e,r){var t={maps:{}},a=e.inputName,s=e.inputNodeName,i=e.nodeName,n=this;return a.forEach((function(e,a){if("Material"===e){var i=n.getNodeByRefName(s[a],r);t.attributes=i.attributes,t.envMap=i.fileName,t.name=s[a]}})),i.forEach((function(e,i){e===t.name&&(t.maps[a[i]]=n.getNodeByRefName(s[i],r))})),t},getNodeByRefName(e,r){for(var t in r)if(r[t].refName===e)return r[t]},parseTextureNodes(e){var r={};for(var t in e){var a=e[t],s=a.fileName;if(!s)return;var i=this.loadTexture(s);switch(void 0!==a.widthWrappingMode&&(i.wrapS=this.getWrappingType(a.widthWrappingMode)),void 0!==a.heightWrappingMode&&(i.wrapT=this.getWrappingType(a.heightWrappingMode)),t){case"Color":r.map=i;break;case"Roughness":r.roughnessMap=i,r.roughness=.5;break;case"Specular":r.specularMap=i,r.specular=16777215;break;case"Luminous":r.emissiveMap=i,r.emissive=8421504;break;case"Luminous Color":r.emissive=8421504;break;case"Metallic":r.metalnessMap=i,r.metalness=.5;break;case"Transparency":case"Alpha":r.alphaMap=i,r.transparent=!0;break;case"Normal":r.normalMap=i,void 0!==a.amplitude&&(r.normalScale=new Vector2(a.amplitude,a.amplitude));break;case"Bump":r.bumpMap=i}}return r.roughnessMap&&r.specularMap&&delete r.specularMap,r},parseAttributeImageMaps(e,r,t){for(var a in e){var s=e[a];if(s.maps){var i=s.maps[0],n=this.getTexturePathByIndex(i.imageIndex,r);if(!n)return;var o=this.loadTexture(n);switch(void 0!==i.wrap&&(o.wrapS=this.getWrappingType(i.wrap.w)),void 0!==i.wrap&&(o.wrapT=this.getWrappingType(i.wrap.h)),a){case"Color":t.map=o;break;case"Diffuse":t.aoMap=o;break;case"Roughness":t.roughnessMap=o,t.roughness=1;break;case"Specular":t.specularMap=o,t.specular=16777215;break;case"Luminosity":t.emissiveMap=o,t.emissive=8421504;break;case"Metallic":t.metalnessMap=o,t.metalness=1;break;case"Transparency":case"Alpha":t.alphaMap=o,t.transparent=!0;break;case"Normal":t.normalMap=o;break;case"Bump":t.bumpMap=o}}}},parseAttributes(e,r){var t={};return e.Color&&!r.map?t.color=(new Color).fromArray(e.Color.value):t.color=new Color,e.Transparency&&0!==e.Transparency.value&&(t.opacity=1-e.Transparency.value,t.transparent=!0),e["Bump Height"]&&(t.bumpScale=.1*e["Bump Height"].value),e["Refraction Index"]&&(t.refractionRatio=1/e["Refraction Index"].value),this.parsePhysicalAttributes(t,e,r),this.parseStandardAttributes(t,e,r),this.parsePhongAttributes(t,e,r),t},parsePhysicalAttributes(e,r){r.Clearcoat&&r.Clearcoat.value>0&&(e.clearcoat=r.Clearcoat.value,r["Clearcoat Gloss"]&&(e.clearcoatRoughness=.5*(1-r["Clearcoat Gloss"].value)))},parseStandardAttributes(e,r,t){r.Luminous&&(e.emissiveIntensity=r.Luminous.value,r["Luminous Color"]&&!t.emissive?e.emissive=(new Color).fromArray(r["Luminous Color"].value):e.emissive=new Color(8421504)),r.Roughness&&!t.roughnessMap&&(e.roughness=r.Roughness.value),r.Metallic&&!t.metalnessMap&&(e.metalness=r.Metallic.value)},parsePhongAttributes(e,r,t){r.Diffuse&&e.color.multiplyScalar(r.Diffuse.value),r.Reflection&&(e.reflectivity=r.Reflection.value,e.combine=AddOperation),r.Luminosity&&(e.emissiveIntensity=r.Luminosity.value,t.emissiveMap||t.map?e.emissive=new Color(8421504):e.emissive=e.color),r.Roughness||!r.Specular||t.specularMap||(r["Color Highlight"]?e.specular=(new Color).setScalar(r.Specular.value).lerp(e.color.clone().multiplyScalar(r.Specular.value),r["Color Highlight"].value):e.specular=(new Color).setScalar(r.Specular.value)),e.specular&&r.Glossiness&&(e.shininess=7+Math.pow(2,12*r.Glossiness.value+2))},parseEnvMap(e,r,t){if(e.envMap){var a=this.loadTexture(e.envMap);t.transparent&&t.opacity<.999?(a.mapping=EquirectangularRefractionMapping,void 0!==t.reflectivity&&(delete t.reflectivity,delete t.combine),void 0!==t.metalness&&delete t.metalness):a.mapping=EquirectangularReflectionMapping,r.envMap=a}},getTexturePathByIndex(e){var r="";return lwoTree.textures?(lwoTree.textures.forEach((function(t){t.index===e&&(r=t.fileName)})),r):r},loadTexture(e){return e?this.textureLoader.load(e,void 0,void 0,(function(){console.warn("LWOLoader: non-standard resource hierarchy. Use `resourcePath` parameter to specify root content directory.")})):null},getWrappingType(e){switch(e){case 0:return console.warn('LWOLoader: "Reset" texture wrapping type is not supported in three.js'),ClampToEdgeWrapping;case 1:return RepeatWrapping;case 2:return MirroredRepeatWrapping;case 3:return ClampToEdgeWrapping}},getMaterialType:e=>e.Clearcoat&&e.Clearcoat.value>0?MeshPhysicalMaterial:e.Roughness?MeshStandardMaterial:MeshPhongMaterial},GeometryParser.prototype={constructor:GeometryParser,parse(e,r){var t=new BufferGeometry;t.addAttribute("position",new Float32BufferAttribute(e.points,3));var a=this.splitIndices(e.vertexIndices,e.polygonDimensions);return t.setIndex(a),this.parseGroups(t,e),t.computeVertexNormals(),this.parseUVs(t,r,a),this.parseMorphTargets(t,r,a),t.translate(-r.pivot[0],-r.pivot[1],-r.pivot[2]),t},splitIndices(e,r){var t=[],a=0;return r.forEach((function(r){if(r<4)for(var s=0;s<r;s++)t.push(e[a+s]);else if(4===r)t.push(e[a],e[a+1],e[a+2],e[a],e[a+2],e[a+3]);else if(r>4){for(s=1;s<r-1;s++)t.push(e[a],e[a+s],e[a+s+1]);console.warn("LWOLoader: polygons with greater than 4 sides are not supported")}a+=r})),t},parseGroups(e,r){var t=lwoTree.tags,a=[],s=3;"lines"===r.type&&(s=2),"points"===r.type&&(s=1);for(var i,n=this.splitMaterialIndices(r.polygonDimensions,r.materialIndices),o=0,c={},h=0,F=0,u=0;u<n.length;u+=2){var p,d=n[u+1];0===u&&(a[o]=t[d]),void 0===i&&(i=d),d!==i&&(c[t[i]]?p=c[t[i]]:(p=o,c[t[i]]=o,a[o]=t[i],o++),e.addGroup(h,F,p),h+=F,i=d,F=0),F+=s}e.groups.length>0&&(c[t[d]]?p=c[t[d]]:(p=o,c[t[d]]=o,a[o]=t[d]),e.addGroup(h,F,p)),e.userData.matNames=a},splitMaterialIndices(e,r){var t=[];return e.forEach((function(e,a){if(e<=3)t.push(r[2*a],r[2*a+1]);else if(4===e)t.push(r[2*a],r[2*a+1],r[2*a],r[2*a+1]);else for(var s=0;s<e-2;s++)t.push(r[2*a],r[2*a+1])})),t},parseUVs(e,r){var t=Array.from(Array(2*e.attributes.position.count),(function(){return 0}));for(var a in r.uvs){var s=r.uvs[a].uvs;r.uvs[a].uvIndices.forEach((function(e,r){t[2*e]=s[2*r],t[2*e+1]=s[2*r+1]}))}e.addAttribute("uv",new Float32BufferAttribute(t,2))},parseMorphTargets(e,r){var t=0;for(var a in r.morphTargets){var s=e.attributes.position.array.slice();e.morphAttributes.position||(e.morphAttributes.position=[]);var i=r.morphTargets[a].points,n=r.morphTargets[a].indices,o=r.morphTargets[a].type;n.forEach((function(e,r){"relative"===o?(s[3*e]+=i[3*r],s[3*e+1]+=i[3*r+1],s[3*e+2]+=i[3*r+2]):(s[3*e]=i[3*r],s[3*e+1]=i[3*r+1],s[3*e+2]=i[3*r+2])})),e.morphAttributes.position[t]=new Float32BufferAttribute(s,3),e.morphAttributes.position[t].name=a,t++}}};export{LWOLoader};