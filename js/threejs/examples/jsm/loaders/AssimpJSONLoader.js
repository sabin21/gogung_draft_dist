import{BufferGeometry,FileLoader,Float32BufferAttribute,Loader,LoaderUtils,Matrix4,Mesh,MeshPhongMaterial,Object3D,RepeatWrapping,TextureLoader}from"../../../build/three.module.js";var AssimpJSONLoader=function(e){Loader.call(this,e)};AssimpJSONLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:AssimpJSONLoader,load:function(e,r,a,t){var s=this,o=""===s.path?LoaderUtils.extractUrlBase(e):s.path,i=new FileLoader(this.manager);i.setPath(s.path),i.load(e,(function(e){var a=JSON.parse(e),i=a.__metadata__;if(void 0!==i){if("assimp2json"!==i.format)return void t("THREE.AssimpJSONLoader: Not an assimp2json scene.");if(i.version<100&&i.version>=200)return void t("THREE.AssimpJSONLoader: Unsupported assimp2json file format version.")}r(s.parse(a,o))}),a,t)},parse:function(e,r){function a(e,r){for(var a=new Array(e.length),t=0;t<e.length;++t)a[t]=r.call(this,e[t]);return a}var t=new TextureLoader(this.manager);t.setPath(this.resourcePath||r).setCrossOrigin(this.crossOrigin);var s=a(e.meshes,(function(e){var r,a,t,s=new BufferGeometry,o=[],i=e.vertices||[],n=e.normals||[],c=e.texturecoords||[],p=e.colors||[];for(c=c[0]||[],r=0,a=e.faces.length;r<a;r++)t=e.faces[r],o.push(t[0],t[1],t[2]);return s.setIndex(o),s.addAttribute("position",new Float32BufferAttribute(i,3)),n.length>0&&s.addAttribute("normal",new Float32BufferAttribute(n,3)),c.length>0&&s.addAttribute("uv",new Float32BufferAttribute(c,2)),p.length>0&&s.addAttribute("color",new Float32BufferAttribute(p,3)),s.computeBoundingSphere(),s})),o=a(e.materials,(function(e){var r=new MeshPhongMaterial;for(var a in e.properties){var s=e.properties[a],o=s.key,i=s.value;switch(o){case"$tex.file":var n=s.semantic;if(1===n||2===n||4===n||5===n||6===n){var c;switch(n){case 1:c="map";break;case 2:c="specularMap";break;case 4:c="emissiveMap";break;case 5:c="bumpMap";break;case 6:c="normalMap"}var p=t.load(i);p.wrapS=p.wrapT=RepeatWrapping,r[c]=p}break;case"?mat.name":r.name=i;break;case"$clr.diffuse":r.color.fromArray(i);break;case"$clr.specular":r.specular.fromArray(i);break;case"$clr.emissive":r.emissive.fromArray(i);break;case"$mat.shininess":r.shininess=i;break;case"$mat.shadingm":r.flatShading=1===i;break;case"$mat.opacity":i<1&&(r.opacity=i,r.transparent=!0)}}return r}));return function e(r,a,t,s){var o,i,n=new Object3D;for(n.name=a.name||"",n.matrix=(new Matrix4).fromArray(a.transformation).transpose(),n.matrix.decompose(n.position,n.quaternion,n.scale),o=0;a.meshes&&o<a.meshes.length;o++)i=a.meshes[o],n.add(new Mesh(t[i],s[r.meshes[i].materialindex]));for(o=0;a.children&&o<a.children.length;o++)n.add(e(r,a.children[o],t,s));return n}(e,e.rootnode,s,o)}});export{AssimpJSONLoader};